(!window.console||!console.log)&&function(){for(var c=function(){},a="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,markTimeline,table,time,timeEnd,timeStamp,trace,warn".split(","),b=a.length,d=window.console={};b--;)d[a[b]]=c}();
Modernizr.load({test:Modernizr.inputtypes.date,yep:"js/vendor/date.js",nope:["css/jqm-datebox.css","js/vendor/jqm-datebox.core.js","js/vendor/jqm-datebox.mode.calbox.js","js/vendor/jquery.mobile.datebox.i18n.da.utf8.js","js/vendor/no-date.js"]});function html5Camera(){return!(!navigator.getUserMedia&&!navigator.webkitGetUserMedia&&!navigator.mozGetUserMedia&&!navigator.msGetUserMedia)}function html5File(){return window.File&&window.FileReader&&window.FileList&&window.Blob}
typeof cordova!="undefined"?Modernizr.load({load:["js/vendor/photo-cordova.js","js/vendor/upload-cordova.js","js/vendor/exif.js","js/vendor/canvasResize.js"]}):(html5File()||html5Camera()?Modernizr.load({load:["js/vendor/photo-html5.js","js/vendor/exif.js","js/vendor/canvasResize.js"]}):Modernizr.load({load:"js/vendor/photo.js"}),window.FormData?Modernizr.load({load:"js/vendor/upload-html5.js"}):Modernizr.load({load:"js/vendor/upload.js"}));
var url="http://service.rapportfrastedet.dk/RapportFraStedet/api/kommune.aspx",imageId,x=0,y=0,vent=1E4,formularInit=!1;
$(document).on("pageshow",function(b){try{var d="",c=!1;switch(b.target.id){case "AlleKommuner":document.title="Alle Kommuner";c=!0;Rfs.showAlleKommuner();d=location.href;break;case "Kommune":document.title=Rfs.kommune.Navn;c=!0;Rfs.showThemes();d=location.href;break;case "Tema":reverse?reverse=!1:(Rfs.showKort(),window.map||(initMap(),fixContentHeight()));document.title=Rfs.kommune.Navn+" - "+Rfs.tema.Navn+" - Kort";c=!0;d=location.href;break;case "Formular":document.title=Rfs.kommune.Navn+" - "+
Rfs.tema.Navn;c=!0;d=location.href;break;case "PhotoPage":document.title=Rfs.kommune.Navn+" - "+Rfs.tema.Navn+" - Kamera";c=!0;d=location.href;break;case "Progress":upload();break;case "Start":document.title="Rapport Fra Stedet";d="";c=!0;break;case "Advarsel":document.title=Rfs.kommune.Navn+" - Advarsel";d="#Advarsel";c=!0;break;case "Kvittering":document.title=Rfs.kommune.Navn+" - "+Rfs.tema.Navn+" - Kvittering",d="#Kvittering",c=!0}c&&(_gaq.push(["_setAccount","UA-24623853-2"]),_gaq.push(["_trackPageview",
d]))}catch(a){}});var reverse=!1;Path.map("#/kommuner").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse};reverse=!1;$.mobile.changePage($("#AlleKommuner"),b)});Path.map("#/kommuner/fejl").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide"};$.mobile.changePage($("#ShowKommunerError"),b)});
Path.map("#/kommune/:kommuneId").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse};reverse=!1;Rfs.showKommune(this.params.kommuneId,b)});Path.map("#/kommune/:kommuneId/dialog").to(function(){var b={dataUrl:location.toString(),changeHash:!1};$.mobile.changePage($("#ModtagerIkkeIndberetning"),b)});
Path.map("#/kommune/:kommuneId/warning").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide"};$.mobile.changePage($("#Warning"),b)});
Path.map("#/kommune/:kommuneId/advarsel").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide"};if(Rfs.kommuner!=null)for(var d=0;d<Rfs.kommuner.length;d++)if(Rfs.kommuner[d].Nr==this.params.kommuneId){Rfs.kommune=Rfs.kommuner[d];break}if(Rfs.kommune!=null){var d=$("#Advarsel"),c="";c+="<h2>"+Rfs.kommune.Navn+" Kommune</h2>";c+="<p>Rapport Fra Stedet kan ikke indberette til denne kommune!</p>";Rfs.kommune.Besked!=""&&(c+="<p>"+Rfs.kommune.Besked+"</p>");Rfs.kommune.URL!=
""&&(c+="<a href='"+Rfs.kommune.URL+"' rel='external' data-ajax='false' data-role='button'>Kontakt</a>");c+="<p>Du kan v\u00e6lge at indberette til en anden kommune.</p>";c+="<a onclick='backToKommuner()' data-role='button' data-theme='b' >V\u00e6lg kommune</a>";$("#update").html(c);d.trigger("create")}$.mobile.changePage($("#Advarsel"),b)});
Path.map("#/kommune/:kommuneId/:temaId").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse},d=this.params.kommuneId,c=this.params.temaId;if(reverse&&Rfs.tema!=null)$.mobile.changePage($("#Tema"),b);else if(Rfs.rapport=null,Rfs.kommune&&Rfs.kommune.Nr==d)if(Rfs.tema&&Rfs.tema.Id==c)$.mobile.changePage($("#Tema"),b);else{Rfs.tema=null;if(Rfs.temaer!=null)for(var a=0;a<Rfs.temaer.length;a++)if(Rfs.temaer[a].Id==c&&Rfs.temaer[a].Nr==d){Rfs.tema=Rfs.temaer[a];
break}Rfs.tema==null?($.mobile.showPageLoadingMsg("a","Henter tema...",!1),$.ajax({url:Rfs.kommune.URL+"/api/Tema.aspx",dataType:"jsonp",timeout:vent,data:{nr:d,id:c},success:function(a){Rfs.tema=a;$.mobile.activePage.selector=="#Tema"?reverse?reverse=!1:(Rfs.showKort(),window.map||(initMap(),fixContentHeight())):$.mobile.changePage($("#Tema"),b)},error:function(){location.hash="#/kommune/"+d+"/"+c+"/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}})):$.mobile.changePage($("#Tema"),b)}else{if(Rfs.kommuner!=
null)for(a=0;a<Rfs.kommuner.length;a++)if(Rfs.kommuner[a].Nr==d){Rfs.kommune=Rfs.kommuner[a];break}Rfs.kommune==null?($.mobile.showPageLoadingMsg("a","Henter kommune...",!1),$.ajax({url:url,dataType:"jsonp",timeout:vent,data:{nr:d},success:function(a){Rfs.kommune=a;$.mobile.showPageLoadingMsg("a","Henter tema...",!1);$.ajax({url:Rfs.kommune.URL+"/api/Tema.aspx",dataType:"jsonp",timeout:vent,data:{nr:d,id:c},success:function(a){Rfs.tema=a;$.mobile.changePage($("#Tema"),b)},error:function(){location.hash=
"#/kommune/"+d+"/"+c+"/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}})},error:function(){location.hash="#/kommune/"+d+"/"+c+"/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}})):$.mobile.changePage($("#Tema"),b)}});Path.map("#/kommune/:kommuneId/:temaId/kamera/:imageId").to(function(){imageId=this.params.imageId;var b={dataUrl:location.toString(),changeHash:!1,transition:"slide"};$.mobile.changePage($("#PhotoPage"),b)});
Path.map("#/kommune/:kommuneId/:temaId/fejl").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse};reverse=!1;$.mobile.changePage($("#ShowKortError"),b)});Path.map("#/kommune/:kommuneId/:temaId/find1").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse};reverse=!1;$.mobile.changePage($("#SearchPage1"),b)});
Path.map("#/kommune/:kommuneId/:temaId/find2").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse};reverse=!1;$.mobile.changePage($("#SearchPage2"),b)});Path.map("#/kommune/:kommuneId/:temaId/find3").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse};reverse=!1;$.mobile.changePage($("#SearchPage3"),b)});
Path.map("#/kommune/:kommuneId/:temaId/formular").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide",reverse:reverse};reverse=!1;$.mobile.changePage($("#Formular"),b)});Path.map("#/kommune/:kommuneId/:temaId/progress").to(function(){var b={dataUrl:location.toString(),changeHash:!1,transition:"slide"};$.mobile.changePage($("#Progress"),b)});
Path.map("#/kommune/:kommuneId/:temaId/kvittering").to(function(){$("#kvitteringTekst").html(Rfs.kvittering);var b={dataUrl:location.toString(),changeHash:!1,transition:"slide"};$.mobile.changePage($("#Kvittering"),b)});Path.map("#/Start").to(function(){$.mobile.changePage($("#Start"),{dataUrl:"",changeHash:!1})});Path.root("#/Start");function showTegn(){$("#Tegn").popup("open")}function showLayers(){$("#layerspage").popup("open")}
function showProgress(){location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/progress"}function backToKommuner(){reverse=!0;location="#/kommuner"}function backToKommune(){reverse=!0;location="#/kommune/"+Rfs.kommune.Nr}function backToFormular(){reverse=!0;location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/formular"}function backToMap(){reverse=!0;location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id}
function backToSearch(b){reverse=!0;location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/find"+b}$(function(){$.mobile.initializePage();Path.listen();$(window).bind("resize orientationchange",function(){fixContentHeight()});$.support.cors=!0});
function geoLocate(){x!=0&&y!=0?Rfs.showPosition():navigator.geolocation?($.mobile.showPageLoadingMsg("a","Finder position...",!1),navigator.geolocation.getCurrentPosition(function(b){$.mobile.hidePageLoadingMsg();x=b.coords.longitude;y=b.coords.latitude;Rfs.lat=b.coords.latitude;Rfs.lon=b.coords.longitude;Rfs.acc=b.coords.accuracy;var b=new Proj4js.Proj("EPSG:4326"),d=new Proj4js.Proj("EPSG:25832"),c=new Proj4js.Point(x,y);Proj4js.transform(b,d,c);x=c.x;y=c.y;Rfs.showPosition()},function(){$.mobile.hidePageLoadingMsg();
location.hash="#/kommuner"},{enableHighAccuracy:!0,maximumAge:0,timeout:6E4})):location.hash="#/kommuner"}
$(document).bind("pageinit",function(b){switch(b.target.id){case "SearchPage1":$("#search1").bind("keyup change",function(){var b=$(this).val();oiorest.search(b)});break;case "Start":typeof cordova=="undefined"&&(b=navigator.userAgent.toLowerCase(),b.indexOf("android")>-1?$("#app").html("<p>Installere Rapport Fra Stedet som app p\u00e5 din smartphone. Klik p\u00e5 nedenst\u00e5ende link.</p><a rel='external' data-ajax='false' href='http://www.rapportfrastedet.dk/RapportFraStedet.apk' ><img src='./img/android.png' alt='Android'/></a>"):(b.indexOf("ipad")>
-1||b.indexOf("iphone")>-1)&&$("#app").html("<p>Installere Rapport Fra Stedet som app p\u00e5 din smartphone. Klik p\u00e5 nedenst\u00e5ende link.</p><a rel='external' data-ajax='false' href='http://itunes.com/apps/rfs' ><img src='./img/apple.png' alt='Apple'/></a>"));break;case "Formular":formularInit=!0,$("#rapportForm").submit(function(){return!1})}});
var Rfs={url:null,mapSet:null,temaer:null,tema:null,rapport:null,kommuner:null,kommune:null,useDrawControl:!1,showMarker:!1,showInfo:!1,lat:0,lon:0,acc:0,ajaxCheck:null,init:function(){$("#Kommune").page();$("#AlleKommuner").page();$("#Formular").page();$("#Advarsel").page();$("#Tema").page()},showAlleKommuner:function(){Rfs.kommuner==null&&($.mobile.showPageLoadingMsg("a","Henter kommuner...",!1),$.ajax({url:url,dataType:"jsonp",timeout:vent,success:function(b){Rfs.kommuner=b;Rfs.kommune=null;Rfs.tema=
null;Rfs.temaer=null;for(var d="",c=0;c<b.length;c++){var a=b[c];d+="<li";a.ModtagerIndberetning==0?(d+=" data-icon='alert'>",d+="<a href='#/kommune/"+a.Nr+"/advarsel' >"):d+="><a href='#/kommune/"+a.Nr+"'>";a.Logo!=""&&(d+="<img src='http://service.rapportfrastedet.dk/RapportFraStedet/Images/Kommuner/"+a.Logo+"' />");d+="<h1>"+a.Navn+"</h1>";a.ModtagerIndberetning==0&&(d+="<a href='#/kommune/"+a.Nr+"/advarsel' data-theme='e'></a>");d+="</a></li>"}b=$("#AlleKommuner").children(":jqmData(role=content)");
b.find("ul").html(d);b.find("ul").listview("refresh")},error:function(){location.hash="#/kommuner/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}}))},showKommune:function(b,d){if(Rfs.kommune&&Rfs.kommune.Nr==b)$.mobile.changePage($("#Kommune"),d);else{Rfs.temaer=null;if(Rfs.kommuner!=null)for(var c=0;c<Rfs.kommuner.length;c++)if(Rfs.kommuner[c].Nr==b){Rfs.kommune=Rfs.kommuner[c];break}Rfs.kommune==null?($.mobile.showPageLoadingMsg("a","Henter kommune...",!1),$.ajax({url:url,dataType:"jsonp",
timeout:vent,data:{nr:b},success:function(a){Rfs.kommune=a;$.mobile.changePage($("#Kommune"),d)},error:function(){location.hash="#/kommune/"+b+"/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}})):$.mobile.changePage($("#Kommune"),d)}},showThemes:function(){Rfs.tema=null;if(!Rfs.temaer)if(Rfs.kommune.ModtagerIndberetning)$.mobile.showPageLoadingMsg("a","Henter temaer...",!1),$.ajax({url:Rfs.kommune.URL+"/api/Tema.aspx",dataType:"jsonp",timeout:vent,data:{nr:Rfs.kommune.Nr,x:x,y:y},success:function(a){Rfs.createKommune(a)},
error:function(){location.hash="#/kommune/"+Rfs.kommune.Nr+"/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}});else{var b=$("#ModtagerIkkeIndberetning"),d=b.children(":jqmData(role=content)"),c="";c+="<h2>Du st\u00e5r i "+Rfs.kommune.Navn+" Kommune</h2>";c+="<p>RapportFraStedet kan ikke indberette til denne kommune!</p>";Rfs.kommune.Besked!=""&&(c+="<p>"+Rfs.kommune.Besked+"</p>");Rfs.kommune.URL!=""&&(c+="<a href='"+Rfs.kommune.URL+"' rel='external' data-ajax='false' data-role='button'>Kontakt</a>");
c+="<p>Du kan v\u00e6lge at indberette til en anden kommune.</p>";c+="<a href='#/kommuner' data-role='button' data-theme='b' >V\u00e6lg kommune</a>";d.html(c);b.trigger("create");location.hash="#/kommune/"+Rfs.kommune.Nr+"/dialog"}},createKommune:function(b){Rfs.temaer=b;var b=$("#Kommune"),d=b.children(":jqmData(role=header)"),c="",c=d.find("img");c[0].src="http://service.rapportfrastedet.dk/RapportFraStedet/Images/Kommuner/"+Rfs.kommune.Logo;c[0].style.visibility=Rfs.kommune.Logo==""?"hidden":"visible";
d.find("h1").html(Rfs.kommune.Navn+" Kommune");c="";for(d=0;d<Rfs.temaer.length;d++){var a=Rfs.temaer[d];c+="<li";a.ModtagerIndberetning==0&&(c+=" data-icon='alert'");c+="><a href='#/kommune/"+Rfs.kommune.Nr+"/"+a.Id+"' data-transition='slide'>";a.Logo!=""&&(c+="<img src='"+a.Logo+"' />");c+="<h1>"+a.Navn+"</h1><p>"+a.Beskrivelse+"</p>";a.ModtagerIndberetning==0&&(c+="<a href='#/kommune/"+Rfs.kommune.Nr+"/warning' data-theme='e' data-rel='dialog' data-transition='slide'></a>");c+="</a></li>"}d=b.children(":jqmData(role=content)");
d.find("ul").html(c);d.find("ul").listview("refresh");b.page()},showKort:function(){$.mobile.showPageLoadingMsg("a","Henter kort...",!1);$("#tegnList").html("<li data-role='divider' data-theme='a'>Tegnev\u00e6rkt\u00f8jer</li>");var b=Rfs.tema.MapAgent.toLowerCase().replace("mapagent/mapagent.fcgi","fusion")+"/layers/mapguide/php/ApplicationDefinition.php?USERNAME=Anonymous&CLIENTAGENT=Rapport+Fra+Stedet+1.0.0&appid="+Rfs.tema.ApplicationDefinition;$.ajax({url:b,dataType:"jsonp",timeout:vent,complete:function(){$.mobile.hidePageLoadingMsg()},
error:function(){location.hash="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/fejl"},success:function(b){Rfs.useDrawControl=!1;Rfs.showMarker=!1;Rfs.url=null;Rfs.FeatureInfo=!1;Rfs.kvittering="<h3>Tak for din indberetning</h3><p>Vil du foretage en ny indberetning?</p>";Rfs.straks="<p>Det er ikke tilladt at indberette p\u00e5 valgte placering.</p><p>Ret placeringen og pr\u00f8v igen.</p>";Rfs.editImage=!1;$("#kortnavbar").hide();$("#backKommune").attr("href","#/kommune/"+Rfs.kommune.Nr);if(b.ApplicationDefinition&&
b.ApplicationDefinition.length>0&&b.ApplicationDefinition[0].MapSet&&b.ApplicationDefinition[0].MapSet.length>0){Rfs.mapSet=b.ApplicationDefinition[0].MapSet[0];oiorest.init();if(b.ApplicationDefinition[0].WidgetSet&&b.ApplicationDefinition[0].WidgetSet.length>0){for(widget in b.ApplicationDefinition[0].WidgetSet[0].Widget){var c=b.ApplicationDefinition[0].WidgetSet[0].Widget[widget];switch(c.Type[0]){case "RfsSearch":var a=c.Extension[0],e=new Search(widget,c.Name[0],c.Disabled[0]=="false");e.placeholder1=
a.placeholder1[0];e.url1=a.url1[0].replace(/%26/gi,"&");e.id1=a.id1[0];e.name1=a.name1[0];e.chars1=a.chars1[0];e.title1=a.title1[0];if(a.placeholder2)e.placeholder2=a.placeholder2[0];if(a.url2)e.url2=a.url2[0].replace(/%26/gi,"&");if(a.id2)e.id2=a.id2[0];if(a.name2)e.name2=a.name2[0];if(a.chars2)e.chars2=a.chars2[0];if(a.title2)e.title2=a.title2[0];if(a.placeholder3)e.placeholder3=a.placeholder3[0];if(a.url3)e.url3=a.url3[0].replace(/%26/gi,"&");if(a.id3)e.id3=a.id3[0];if(a.name3)e.name3=a.name3[0];
if(a.chars3)e.chars3=a.chars3[0];if(a.title3)e.title3=a.title3[0];e.url=a.url[0].replace(/%26/gi,"&");e.x1=a.x1[0];e.y1=a.y1[0];if(a.zoom)e.zoom=a.zoom[0];e.projection=a.projection[0];oiorest.items.push(e);break;case "RapportFraStedet":$("#kortnavbar").show();a=c.Extension[0];if(a.kvittering)Rfs.kvittering=a.kvittering[0];if(a.straks)Rfs.straks=a.straks[0];if(a.editImage)Rfs.editImage=a.editImage[0]=="true";if(a.type[0]!="-1"&&a.type[0]!="0")$("#tegnList").html("<li data-role='divider' data-theme='a'>Tegnev\u00e6rkt\u00f8jer</li>"),
Rfs.useDrawControl=!0;if(a.type[0]=="0")Rfs.showMarker=!0;(a.type[0]=="1"||a.type[0]=="3"||a.type[0]=="5"||a.type[0]=="7")&&$("<li id='tegnPunkt' data-icon='check'><a href='#' data-rel='back' onclick='Point()'>Punkt</a></li>").appendTo("#tegnList");(a.type[0]=="2"||a.type[0]=="3"||a.type[0]=="6"||a.type[0]=="7")&&$("<li id='tegnLinie' data-icon='check'><a href='#' data-rel='back' onclick='Line()'>Linie</a></li>").appendTo("#tegnList");(a.type[0]=="4"||a.type[0]=="5"||a.type[0]=="6"||a.type[0]=="7")&&
$("<li id='tegnPolygon' data-icon='check'><a href='#' data-rel='back' onclick='Polygon()'>Polygon</a></li>").appendTo("#tegnList");a.type[0]!="-1"&&a.type[0]!="0"&&($("<li id='tegnRediger' data-icon='check'><a href='#' data-rel='back' onclick='Modify()'>Rediger</a></li>").appendTo("#tegnList"),$("<li id='tegnNaviger' data-icon='check' class='checked'><a href='#' data-rel='back' onclick='Navigate()'>Naviger</a></li>").appendTo("#tegnList"),$("#tegnList").listview("refresh"));if(a.Url)Rfs.url=a.Url[0];
break;case "FeatureInfo":Rfs.FeatureInfo=!0}}$("#Tema");b=$("#headerKort").html("");$("<a data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-a' data-theme='a' data-icon='locate' onclick='locate()' >Position</a>").button().appendTo(b);oiorest.items.length>0?($("<a data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-b' data-theme='a' href='#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/find1' data-icon='search' >S\u00f8g</a>").button().appendTo(b),
Rfs.useDrawControl?($("<a onclick='showTegn()' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c' data-theme='a' data-icon='star' >Tegn</a>").button().appendTo(b),$("<a onclick='showLayers()' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-d' data-theme='a' data-icon='layers' >Kort</a>").button().appendTo(b),b.removeClass("ui-grid-a"),b.removeClass("ui-grid-b"),b.addClass("ui-grid-c")):($("<a onclick='showLayers()' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c' data-theme='a' data-icon='layers' >Kort</a>").button().appendTo(b),
b.removeClass("ui-grid-a"),b.removeClass("ui-grid-c"),b.addClass("ui-grid-b"))):Rfs.useDrawControl?($("<a onclick='showTegn()' data-theme='a' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c' data-icon='star'>Tegn</a>").button().appendTo(b),$("<a onclick='showLayers()' data-theme='a' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-d' data-icon='layers' >Kort</a>").button().appendTo(b),b.removeClass("ui-grid-a"),
b.removeClass("ui-grid-c"),b.addClass("ui-grid-b")):($("<a onclick='showLayers()' data-theme='a' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c'  data-icon='layers' >Kort</a>").button().appendTo(b),b.removeClass("ui-grid-b"),b.removeClass("ui-grid-c"),b.addClass("ui-grid-a"));if(oiorest.items.length>1){$("#searchOptionsDiv").html("<fieldset id='searchOptions' data-role='controlgroup'><legend>S\u00f8gemuligheder</legend></fieldset>");for(e in oiorest.items)oiorest.items[e].createCheckBox();
$("#SearchPage1").trigger("create")}else $("#searchOptionsDiv").html("")}fixContentHeight();Rfs.url?(e=Rfs.url.replace("Data.aspx/Index","api/DataApi.aspx"),Rfs.url=Rfs.url.substr(0,Rfs.url.indexOf("/Data.aspx/Index")),$.mobile.showPageLoadingMsg("a","Henter formular...",!1),$.ajax({url:e,dataType:"jsonp",success:function(a){Rfs.createform(a)},error:function(){location.hash="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}})):createMap()}}})},
createFieldcontain:function(){return $("<div>",{"data-role":"fieldcontain"})},createLabel:function(b){var d=null;return d=b.Required==1?$("<label for='"+b.Id+"'><em>*</em>"+b.Name+"</label>"):$("<label for='"+b.Id+"'>"+b.Name+"</label>")},createform:function(b){Rfs.rapport=b;Rfs.fieldset&&(Rfs.fieldset.remove(),delete Rfs.fieldset);var b=b.Felter,d=$("#Formular").children(":jqmData(role=header)"),c=d.find("img");c[0].src=Rfs.tema.Logo;c[0].style.visibility=Rfs.tema.Logo==""?"hidden":"visible";d.find("h1").html(Rfs.tema.Navn);
var a,c=$("#rapportForm");c.html("");c.append("<input type='hidden' name='FormId' value='"+Rfs.rapport.FormId+"'/>");c.append("<input type='hidden' name='UniqueId' value='"+Rfs.rapport.UniqueId+"'/>");c.append("<input type='hidden' name='ItemId' value='"+Rfs.rapport.ItemId+"'/>");c.append("<input type='hidden' name='ViewId' value='"+Rfs.rapport.ViewId+"'/>");c.append("<input type='hidden' name='UserId' value='"+Rfs.rapport.UserId+"'/>");c.append("<input type='hidden' name='Date' value='"+Rfs.rapport.Date+
"'/>");d=$("<fieldset>");Rfs.fieldset=d;c.append(d);for(c=0;c<b.length;c++){var e=b[c];if(!e.Data)e.Data="";if(e.Permission==0){handled=!0;a=$("<input>").attr("type","hidden").val(e.Data);switch(e.TypeId){case 16:a.attr({name:"Geometri",id:"Geometri"});break;case 17:a.attr({name:"Position",id:"Position"});break;case 18:a.attr({name:"Accuracy",id:"Accuracy"});break;default:a.attr({name:e.Id,id:e.Id})}e.Required==1&&a.addClass("required");d.append(a)}else switch(e.TypeId){case 1:a=Rfs.createFieldcontain();
d.append(a);a.append(Rfs.createLabel(e));a.trigger("create");break;case 2:a=Rfs.createFieldcontain();d.append(a);a.append(Rfs.createLabel(e));var h=$("<input type='text' id='"+e.Id+"' name='"+e.Id+"' value='"+e.Data+"'/>");e.Required==1&&h.addClass("required");e.Permission==1&&h.attr("disabled","disabled");a.append(h);a.trigger("create");break;case 3:a="<div data-role='fieldcontain'>";a+="<label for='"+e.Id+"'>";e.Required==1&&(a+="<em>*</em>");a+=e.Name+"</label>";a+="<select id='"+e.Id+"' name='"+
e.Id+"' value='"+e.Data+"'";e.Required==1&&(a+=" class='required'");e.Permission==1&&(a+=" disabled='disabled'");a+=">";a+="<option value='' data-placeholder='true'>-- V\u00e6lg --</option>";for(var h=e.Selections,j=0;j<h.length;j++){var f=h[j];a+="<option value='"+f.Name+"'";f.Selected==1&&(a+=" selected='selected'");a+=">"+f.Name+"</option>"}a+="</select>";a+="</div>";d.append($(a));break;case 4:a="<div data-role='fieldcontain'>";a+="<div data-role='controlgroup'><legend>";e.Required==1&&(a+="<em>*</em>");
a+=e.Name+"</legend>";h=e.Selections;for(j=0;j<h.length;j++)f=h[j],a+="<input type='radio' id='"+f.Id+"' name='"+e.Id+"' value='"+f.Name+"'",f.Selected==1&&(a+=" checked='checked'"),e.Required==1&&(a+=" class='required'"),e.Permission==1&&(a+=" disabled='disabled'"),a+="/><label for='"+f.Id+"'>"+f.Name+"</label>";a+="</div>";a+="</div>";d.append($(a));break;case 5:a="<div data-role='fieldcontain'>";a+="<label for='"+e.Id+"'>";e.Required==1&&(a+="<em>*</em>");a+=e.Name+"</label>";a+="<textarea id='"+
e.Id+"' name='"+e.Id+"'";e.Required==1&&(a+=" class='required'");e.Permission==1&&(a+=" disabled='disabled'");a+=">";a+=e.Data;a+="</textarea>";a+="</div>";d.append($(a));break;case 6:case 12:case 13:a="<div data-role='fieldcontain'>";a+="<label for='"+e.Id+"'>";e.Required==1&&(a+="<em>*</em>");a+=e.Name+"</label>";a+="<select id='"+e.Id+"' name='"+e.Id+"' data-role='slider'";e.Required==1&&(a+=" class='required'");e.Permission==1&&(a+=" disabled='disabled'");a+=">";a+="<option value='off'>Nej</option>";
a+=e.Data.toLowerCase()=="true"?"<option value='on' selected='selected'>Ja</option>":"<option value='on'>Ja</option>";a+="</select>";a+="</div>";d.append($(a));break;case 7:a="<div data-role='fieldcontain'>";a+="<label for='"+e.Id+"'>";e.Required==1&&(a+="<em>*</em>");a+=e.Name+"</label>";a+="<input type='email' id='"+e.Id+"' name='"+e.Id+"' value='"+e.Data+"'";e.Required==1&&(a+=" class='required'");e.Permission==1&&(a+=" disabled='disabled'");a+=" />";a+="</div>";d.append($(a));break;case 8:a=$("<div>");
d.append(a);a.photo({id:e.Id,required:e.Required,name:e.Name,permission:e.Permission});break;case 10:d.append($(markupDate(e)));break;case 14:a="<div data-role='fieldcontain'>";a+="<a data-role='button' data-inline='true' href='"+e.Data+"'>"+e.Name+"</a>";a+="</div>";d.append($(a));break;case 15:a="<div data-role='fieldcontain'>";a+="<label for='"+e.Id+"'>";e.Required==1&&(a+="<em>*</em>");a+=e.Name+"</label>";a+="<input type='text' id='"+e.Id+"' name='"+e.Id+"' value='"+e.Data+"'";e.Required==1&&
(a+=" class='required'");e.Permission==1&&(a+=" disabled='disabled'");a+=" />";a+="</div>";d.append($(a));break;case 16:h=Rfs.createLabel(e);a=Rfs.createFieldcontain();d.append(a);h.attr("for","Geometri");a.append(h);h=$("<textarea id='Geometri' name='Geometri'>"+e.Data+"</textarea>");e.Required==1&&h.addClass("required");e.Permission==1&&h.attr("disabled","disabled");a.append(h);a.trigger("create");break;case 17:a="<div data-role='fieldcontain'>";a+="<label for='Position'>";e.Required==1&&(a+="<em>*</em>");
a+=e.Name+"</label>";a+="<textarea id='Position' name='Position'";e.Required==1&&(a+=" class='required'");e.Permission==1&&(a+=" disabled='disabled'");a+=">";a+=e.Data;a+="</textarea>";a+="</div>";d.append($(a));break;case 18:a="<div data-role='fieldcontain'>";a+="<label for='Accuracy'>";e.Required==1&&(a+="<em>*</em>");a+=e.Name+"</label>";a+="<input type='text' id='Accuracy' name='Accuracy' value='"+e.Data+"'";e.Required==1&&(a+=" class='required'");e.Permission==1&&(a+=" disabled='disabled'");
a+=" />";a+="</div>";d.append($(a));break;case 22:d.append($("<hr />"));break;case 23:a="<h1>"+e.Name+"</h1>";d.append($(a));break;case 24:a="<p>"+e.Name+"</p>",d.append($(a))}}formularInit&&$("#rapportForm").trigger("create");$("#rapportForm").validate({ignore:"",highlight:function(a){a.type&&a.type=="radio"?$(a.parentElement.parentElement).children().find("label").addClass("highlighterror"):a.type&&a.type=="textarea"?$(a).addClass("highlighterror"):$(a.parentElement).addClass("highlighterror")},
unhighlight:function(a){a.type&&a.type=="radio"?$(a.parentElement.parentElement).children().find("label").removeClass("highlighterror"):a.type&&a.type=="textarea"?$(a).removeClass("highlighterror"):$(a.parentElement).removeClass("highlighterror")},errorPlacement:function(a,b){b[0].type&&b[0].type=="radio"?a.insertAfter($(b).parent().parent()):b[0].type&&b[0].type=="select-one"?a.insertAfter($(b).parent().parent()):b[0].type&&b[0].type=="textarea"?a.insertAfter($(b)):a.insertAfter($(b).parent())}});
Rfs.showInfo=!0;createMap()},inputChanged:function(){imageId=this.name.substring(1);if(html5File()){var b=this.files[0];if(b.type.match("image.*")){var d=new FileReader;d.onload=function(){return function(b){var a=new Image;a.onload=function(){var a=this.width,b=this.height,c=$("#C"+imageId)[0];c.height=b/1;c.width=a/1;c.getContext("2d").drawImage(this,0,0,a/1,b/1);$("#A"+imageId).attr("src",c.toDataURL("image/jpeg",1)).css("display","inline");$("#"+imageId).val(c.toDataURL("image/jpeg",1))};a.src=
b.target.result;$("#A"+imageId).attr("src",b.target.result).css("display","inline");$("#"+imageId).val(b.target.result);b=$("input[name='B"+imageId+"']");if(b.length>0)b.unbind("change"),b[0].outerHTML=b[0].outerHTML,$("input[name='B"+imageId+"']").bind("change",Rfs.inputChanged)}}(b);d.readAsDataURL(b)}}},showPosition:function(){$.mobile.showPageLoadingMsg("a","Henter temaer...",!1);$.ajax({url:url,dataType:"jsonp",timeout:vent,data:{x:x,y:y},success:function(b){Rfs.kommune=b;if(b.ModtagerIndberetning)location.hash=
"#/kommune/"+b.Nr;else{var d=$("#ModtagerIkkeIndberetning"),c=d.children(":jqmData(role=content)"),a="";a+="<h2>Du st\u00e5r i "+b.Navn+" Kommune</h2>";a+="<p>RapportFraStedet kan ikke indberette til denne kommune!</p>";Rfs.kommune.Besked!=""&&(a+="<p>"+b.Besked+"</p>");b.URL!=""&&(a+="<a href='"+b.URL+"' rel='external' data-ajax='false' data-role='button'>Kontakt</a>");a+="<p>Du kan v\u00e6lge at indberette til en anden kommune.</p>";a+="<a href='#/kommuner' data-role='button' data-theme='b' >V\u00e6lg kommune</a>";
c.html(a);d.trigger("create");location.hash="#/kommune/"+b.Nr+"/dialog"}},error:function(){location.hash="#/kommuner/fejl"},complete:function(){$.mobile.hidePageLoadingMsg()}})},Validate:function(){$("#rapportForm").valid()&&$("#Confirm").popup("open",{positionTo:"window",transition:"pop"})},checkIndberetning:function(){Rfs.ajaxCheck!=null&&Rfs.ajaxCheck.abort();var b=$("#Position");b.length>0&&Rfs.lon&&Rfs.lat&&b.val("POINT("+Rfs.lon+" "+Rfs.lat+")");b=$("#Accuracy");b.length>0&&Rfs.acc&&b.val(Rfs.acc);
b=$("#Geometri");b.length>0?($.mobile.showPageLoadingMsg("a","Validerer placering...",!1),Rfs.ajaxCheck=$.ajax({url:Rfs.url+"/api/Tema.aspx",dataType:"jsonp",timeout:vent,data:{id:Rfs.tema.Id,geometri:b.val()},success:function(b){b==!0?location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/formular":($("#straks").html(Rfs.straks),$("#GeometryError").popup("open"))},error:function(){$("#errorValidateLocation").popup("open")},complete:function(){$.mobile.hidePageLoadingMsg()}})):$("#GeometryError").popup("open")}},
kommuneNr=null,oiorest={kommuneNr:null,kommuner:null,vejNr:null,ajax:[],items:null,activeSearch:null,search:function(b){for(var d=0;d<this.items.length;d++)if(this.items[d].text1!=b)this.items[d].text1=b,this.items[d].search1()},init:function(){$("#searchOptions>.ui-controlgroup-controls").html("");$("#searchResult1").html("");this.items=[];$("#SearchPage1").page();$("#SearchPage2").page();$("#SearchPage3").page();$("#searchInput2").bind("keyup change",function(){var b=$(this).val();if(b.length>=
oiorest.activeSearch.chars2&&oiorest.activeSearch.text2!=b)oiorest.activeSearch.text2=b,oiorest.activeSearch.search2()});$("#searchInput3").bind("keyup change",function(){var b=$(this).val();if(b.length>=oiorest.activeSearch.chars3&&oiorest.activeSearch.text3!=b)oiorest.activeSearch.text3=b,oiorest.activeSearch.search3()})}};
Search=function(b,d,c){this.id=b;this.title=d;this.checked=c;this.chars3=this.chars2=this.chars1=this.placeholder3=this.placeholder2=this.placeholder1=this.name3=this.name2=this.name1=this.id3=this.id2=this.id1=this.url3=this.url2=this.url1=this.title3=this.title2=this.title1=this.projection=this.url=this.y2=this.x2=this.y1=this.x1=this.ajax=null;this.text3=this.text2=this.text1="";this.zoom=this.selection3=this.selection2=this.selection1=null;var a=this;$("<ul>",{id:"searchList"+this.id,"data-role":"listview",
"data-inset":"true","data-count-theme":"b"}).appendTo("#searchResult1").listview();this.createCheckBox=function(){var b=$("<input>",{name:"searchOption"+this.id,id:"searchOption"+this.id,type:"checkbox"});a.checked&&b.attr("checked","checked");b.bind("change",function(b){a.checked=b.target.checked;a.checked?a.search1():$("#searchList"+a.id).html("")});b.appendTo("#searchOptions");$("<label>",{"for":"searchOption"+a.id,text:this.title}).appendTo("#searchOptions")};this.search1=function(){if(a.checked&&
($("#searchList"+a.id).html(""),a.text1.length>=a.chars1))a.ajax!=null&&a.ajax.abort(),$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1),a.ajax=$.ajax({url:a.url1.replace("[text]",a.text1).replace("[kommune]",Rfs.kommune.Nr),dataType:"jsonp",timeout:vent,success:function(b){$("<li data-role='list-divider'>"+a.title1+"<span class='ui-li-count'>"+b.length+"</span></li>").appendTo("#searchList"+a.id);for(var c=0;c<b.length;c++){for(var d=a.name1,f=a.name1.match(/\[.+?\]/g);f.length;)var g=f.shift(),
k=getPath(b[c],g.replace("[","").replace("]","")),d=d.replace(g,k);a.addItem1(getPath(b[c],a.id1),d)}$("#searchList"+a.id).listview("refresh")},complete:function(){$.mobile.hidePageLoadingMsg()}})};this.search2=function(){$("#searchResult2").html("");a.ajax!=null&&a.ajax.abort();$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1);a.ajax=$.ajax({url:a.url2.replace("[text]",a.text2).replace("[kommune]",Rfs.kommune.Nr).replace("[selection1]",a.selection1),dataType:"jsonp",timeout:vent,success:function(b){for(var c=
0;c<b.length;c++){for(var d=a.name2,f=a.name2.match(/\[.+?\]/g);f.length;)var g=f.shift(),k=getPath(b[c],g.replace("[","").replace("]","")),d=d.replace(g,k);a.addItem2(getPath(b[c],a.id2),d)}$("#searchResult2").listview("refresh")},complete:function(){$.mobile.hidePageLoadingMsg()}})};this.search3=function(){$("#searchResult3").html("");a.ajax!=null&&a.ajax.abort();$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1);a.ajax=$.ajax({url:a.url3.replace("[text]",a.text3).replace("[kommune]",Rfs.kommune.Nr).replace("[selection1]",
a.selection1).replace("[selection2]",a.selection2),dataType:"jsonp",timeout:vent,success:function(b){for(var c=0;c<b.length;c++){for(var d=a.name3,f=a.name3.match(/\[.+?\]/g);f.length;)var g=f.shift(),k=getPath(b[c],g.replace("[","").replace("]","")),d=d.replace(g,k);a.addItem3(getPath(b[c],a.id3),d)}$("#searchResult3").listview("refresh")},complete:function(){$.mobile.hidePageLoadingMsg()}})};this.addItem1=function(b,c){$("<li>").append($("<a />",{text:c}).click(function(){oiorest.activeSearch=a;
a.selection1=b;a.url2?($("#SearchPage2").children(":jqmData(role=header)").find("h1").html(a.title2),$("#searchInput2").val(""),$("#searchInput2").attr("placeholder",a.placeholder2),$("#searchResult2").html(""),a.chars2>0?$("#searchHint2").html("Indtast minimum "+a.chars2+" karakterer!"):($("#searchHint2").html(""),a.text2="",a.search2()),location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/find2"):a.getPosition(c)})).appendTo("#searchList"+a.id)};this.addItem2=function(b,c){$("<li>").append($("<a />",
{text:c}).click(function(){oiorest.activeSearch=a;a.selection2=b;a.url3?($("#SearchPage3").children(":jqmData(role=header)").find("h1").html(a.title3),$("#searchInput3").val(""),$("#searchInput3").attr("placeholder",a.placeholder3),$("#searchResult3").html(""),a.chars3>0?$("#searchHint3").html("Indtast minimum "+a.chars3+" karakterer!"):($("#searchHint3").html(""),a.text3="",a.search3()),location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id+"/find3"):a.getPosition(c)})).appendTo("#searchResult2")};
this.addItem3=function(b,c){$("<li>").append($("<a />",{text:c}).click(function(){oiorest.activeSearch=a;a.selection3=b;a.getPosition(c)})).appendTo("#searchResult3")};this.getPosition=function(b){a.ajax!=null&&a.ajax.abort();$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1);a.ajax=$.ajax({url:a.url.replace("[text]",b).replace("[kommune]",Rfs.kommune.Nr).replace("[selection1]",a.selection1).replace("[selection2]",a.selection2).replace("[selection3]",a.selection3),dataType:"jsonp",timeout:vent,success:function(b){var c=
null;try{c=map.projection.getCode()}catch(d){c=map.projection}var e=null,e=c=="ETRS89.UTM-32N"?new OpenLayers.Projection("EPSG:25832"):map.projection;a.x2?(c=new OpenLayers.Geometry.Point(getPath(b,a.x1),getPath(b,a.y1)),b=new OpenLayers.Geometry.Point(getPath(b,a.x2),getPath(b,a.y2)),c.transform(new OpenLayers.Projection(a.projection),mapPojection),b.transform(new OpenLayers.Projection(a.projection),e),e=new OpenLayers.Bounds(c.x,c.y,b.x,b.y),map.zoomToExtent(e)):(b=new OpenLayers.Geometry.Point(getPath(b,
a.x1),getPath(b,a.y1)),b.transform(new OpenLayers.Projection(a.projection),e),vector.removeAllFeatures(),vector.addFeatures([new OpenLayers.Feature.Vector(b,{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10})]),a.zoom?(e=a.zoom/2,map.zoomToExtent([b.x-e,b.y-e,b.x+e,b.y+e])):map.zoomToExtent(vector.getDataExtent()));reverse=!0;location="#/kommune/"+Rfs.kommune.Nr+"/"+Rfs.tema.Id},complete:function(){$.mobile.hidePageLoadingMsg()}})}};
function getPath(b,d){b.length>0&&(b=b[0]);for(var c=d.split(".");c.length&&b;)b=b[c.shift()];return b}var apiKey="AuNxzdIgj_DsnHh_sCAkkhlwPbfe1B-m890rn4sjfAG1niRi3lCjtxunctjRCn-Q",map,activeControl,pointControl,pathControl,polygonControl,modifyControl,removeControl,navigationControl,redline,vector,crosshairsLayer,crosshairMarker,icon,geolocate,startLocate;
function Point(){$("#tegnPunkt").addClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=pointControl;activeControl.activate()}
function Line(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").addClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=pathControl;activeControl.activate()}
function Polygon(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").addClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=polygonControl;activeControl.activate()}
function Modify(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").addClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=modifyControl;activeControl.activate()}
function Navigate(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").addClass("checked");activeControl&&activeControl.deactivate();activeControl=null}
function Move(){if(Rfs.showMarker){var b=map.getExtent();crosshairMarker&&crosshairsLayer.removeMarker(crosshairMarker);crosshairMarker=new OpenLayers.Marker(new OpenLayers.LonLat(b.left+(b.right-b.left)/2,b.bottom+(b.top-b.bottom)/2),icon);crosshairsLayer.addMarker(crosshairMarker);if(Rfs.rapport&&Rfs.rapport.SRS){var d=$("#Geometri");if(d.length>0){var c=null;try{c=map.projection.getCode()}catch(a){c=map.projection}var e=null,e=c=="ETRS89.UTM-32N"?new OpenLayers.Projection("EPSG:25832"):map.projection,
c=new OpenLayers.Projection(Rfs.rapport.SRS),b=new OpenLayers.Geometry.Point(b.left+(b.right-b.left)/2,b.bottom+(b.top-b.bottom)/2);b.transform(e,c);d.val(b.toString())}}}}
function initMap(){startLocate=!0;crosshairsLayer=new OpenLayers.Layer.Markers("Crosshairs Layer");vector=new OpenLayers.Layer.Vector("Vector Layer",{});var b=new OpenLayers.Size(100,100),d=new OpenLayers.Pixel(-50,-50);icon=new OpenLayers.Icon("./img/crosshair.png",b,d);redline=new OpenLayers.Layer.Vector("Redline Layer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{pointRadius:20,graphicName:"circle",fillColor:"white",fillOpacity:0.25,
strokeWidth:3,strokeOpacity:1,strokeColor:"#ff6600"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#ff6600"},Polygon:{strokeWidth:3,strokeOpacity:1,fillColor:"#ff6600",strokeColor:"#ff6600"}}})]}),select:new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{pointRadius:20,graphicName:"circle",fillColor:"white",fillOpacity:0.25,strokeWidth:3,strokeOpacity:1,strokeColor:"#ff9900"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#ff9900"},Polygon:{strokeWidth:3,strokeOpacity:1,
fillColor:"#ff9900",strokeColor:"#ff9900"}}})]}),temporary:new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{graphicName:"circle",pointRadius:20,fillColor:"white",fillOpacity:0.25,strokeWidth:3,strokeColor:"#ff3300"},Line:{pointRadius:20,strokeWidth:3,strokeOpacity:1,strokeColor:"#ff3300"},Polygon:{strokeWidth:3,strokeOpacity:1,strokeColor:"#ff3300",fillColor:"#ff3300"}}})]})})});redline.events.register("beforefeatureadded",this,function(a){redline.removeAllFeatures();if(Rfs.rapport&&
Rfs.rapport.SRS){var b=$("#Geometri");if(b.length>0){var c=null;try{c=map.projection.getCode()}catch(d){c=map.projection}var f=null,f=c=="ETRS89.UTM-32N"?new OpenLayers.Projection("EPSG:25832"):map.projection,c=new OpenLayers.Projection(Rfs.rapport.SRS),a=a.feature.geometry.clone();a.transform(f,c);b.val(a.toString())}}});modifyControl=new OpenLayers.Control.ModifyFeature(redline);pointControl=new OpenLayers.Control.DrawFeature(redline,OpenLayers.Handler.Point);pathControl=new OpenLayers.Control.DrawFeature(redline,
OpenLayers.Handler.Path);polygonControl=new OpenLayers.Control.DrawFeature(redline,OpenLayers.Handler.Polygon);navigationControl=new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:!0}});geolocate=new OpenLayers.Control.Geolocate({id:"locate-control",geolocationOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:6E4}});var c={fillOpacity:0.1,fillColor:"#000",strokeColor:"#f00",strokeOpacity:0.6};geolocate.events.register("locationfailed",this,function(a){var b="<p>";switch(a.error.code){case 1:b+=
"Det er ikke tilladt at bruge GPS enheden";break;case 2:b+="Der kunne ikke opn\u00e5s en position";break;case 3:b+="Der skete en timeout ved bestemmelse af positionen"}b+="</p><p>"+a.error.message+"</p>";$("#LocationErrorMessage").html(b);$("#LocationError").popup("open")});geolocate.events.register("locationupdated",this,function(a){Rfs.lat=a.position.coords.latitude;Rfs.lon=a.position.coords.longitude;Rfs.acc=a.position.coords.accuracy;vector.removeAllFeatures();vector.addFeatures([new OpenLayers.Feature.Vector(a.point,
{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,50,0),{},c)]);map.zoomToExtent(vector.getDataExtent());Rfs.useDrawControl||vector.removeAllFeatures()});map=new OpenLayers.Map({div:"map",theme:null,controls:[geolocate,pointControl,pathControl,polygonControl,modifyControl,navigationControl],layers:[redline,
vector,crosshairsLayer],eventListeners:{move:Move}});$("#plus").click(function(){map.zoomIn()});$("#minus").click(function(){map.zoomOut()});$(window).bind("resize orientationchange",function(){fixContentHeight()});map.events.register("zoomend",this,function(){startLocate&&(startLocate=!1,locate())});createMap()}function locate(){geolocate.active?geolocate.getCurrentLocation():geolocate.activate()}
function createMap(){if(map&&Rfs.mapSet){geolocate.deactivate();startLocate=!0;crosshairMarker&&crosshairsLayer.removeMarker(crosshairMarker);redline.removeAllFeatures();Navigate();$("#layerslist").html("<li data-role='divider' data-theme='a'>Baggrundskort</li>");var b=map.layers.length;for(i=0;i<b;i++)map.removeLayer(map.layers[0],!1);map.addLayer(redline);map.addLayer(vector);map.addLayer(crosshairsLayer);b=!1;for(mapGroupItem in Rfs.mapSet.MapGroup)for(mapItem in Rfs.mapSet.MapGroup[mapGroupItem].Map){var d=
Rfs.mapSet.MapGroup[mapGroupItem].Map[mapItem];switch(d.Type[0]){case "WMS":b=new OpenLayers.Layer.WMS(d.Extension[0].Options[0].name[0],d.Extension[0].Options[0].url[0].replace(/%26/gi,"&"),{layers:d.Extension[0].Options[0].layer[0]},{isBaseLayer:!0,transitionEffect:"resize",units:"m",projection:d.Extension[0].ProjectionCode[0],maxExtent:new OpenLayers.Bounds.fromArray(d.Extension[0].Options[0].maxExtent[0].split(","))});map.addLayer(b);addLayerToList({ol:b,name:b.name,visible:!0});map.maxExtent=
b.maxExtent;map.units="m";map.projection=b.projection;b=!0;break;case "WMTS":wmts(d);break;case "MapGuide":mapguide(d);break;case "OpenStreetMap":b=new OpenLayers.Layer.OSM(d.Extension[0].Options[0].name[0]);map.addLayer(b);addLayerToList({ol:b,name:b.name,visible:!0});b=!0;break;case "Google":var c=d.Extension[0].Options[0].name[0];switch(d.Extension[0].Options[0].type[0]){case "G_PHYSICAL_MAP":case "TERRAIN":b=new OpenLayers.Layer.Google(c,{type:google.maps.MapTypeId.TERRAIN});map.addLayer(b);addLayerToList({ol:b,
name:b.name,visible:!0});b=!0;break;case "G_HYBRID_MAP":case "HYBRID":b=new OpenLayers.Layer.Google(c,{type:google.maps.MapTypeId.HYBRID});map.addLayer(b);addLayerToList({ol:b,name:b.name,visible:!0});b=!0;break;case "G_SATELLITE_MAP":case "SATELLITE":b=new OpenLayers.Layer.Google(c,{type:google.maps.MapTypeId.SATELLITE});map.addLayer(b);addLayerToList({ol:b,name:b.name,visible:!0});b=!0;break;case "G_NORMAL_MAP":case "ROADMAP":b=new OpenLayers.Layer.Google(c,{type:google.maps.MapTypeId.ROADMAP}),
map.addLayer(b),addLayerToList({ol:b,name:b.name,visible:!0}),b=!0}break;case "VirtualEarth":switch(c=d.Extension[0].Options[0].name[0],d.Extension[0].Options[0].type[0]){case "Road":b=new OpenLayers.Layer.Bing({key:apiKey,type:"Road",metadataParams:{mapVersion:"v1"},name:c});map.addLayer(b);addLayerToList({ol:b,name:b.name,visible:!0});b=!0;break;case "Aerial":b=new OpenLayers.Layer.Bing({key:apiKey,type:"Aerial",name:c});map.addLayer(b);addLayerToList({ol:b,name:b.name,visible:!0});b=!0;break;case "Hybrid":b=
new OpenLayers.Layer.Bing({key:apiKey,type:"AerialWithLabels",name:c}),map.addLayer(b),addLayerToList({ol:b,name:b.name,visible:!0}),b=!0}}}b&&($("#layerslist").listview("refresh"),map.zoomToMaxExtent());if(Rfs.showInfo)Rfs.showInfo=!1,Rfs.useDrawControl?$("#KortInfoDraw").popup("open"):$("#KortInfo").popup("open")}}
function wmts(b){if(typeof cordova==="undefined")OpenLayers.ProxyHost="http://www.rapportfrastedet.dk/proxy.cgi?url=";var d=b.Extension[0].Options[0].url[0].replace(/%26/gi,"&");OpenLayers.Request.GET({url:d,params:{SERVICE:"WMTS",VERSION:"1.0.0",REQUEST:"GetCapabilities"},success:function(c){var a=b.Extension[0].Options[0].name[0];OpenLayers.ProxyHost=null;var e={layer:b.Extension[0].Options[0].layer[0],matrixSet:b.Extension[0].Options[0].matrixSet[0],style:b.Extension[0].Options[0].style[0],url:d,
units:b.Extension[0].Options[0].units[0]},h=c.responseXML;if(!h||!h.documentElement)h=c.responseText;c=new OpenLayers.Format.WMTSCapabilities;h=c.read(h);c=c.createLayer(h,e);c.options.resolutions=Array(c.matrixIds.length);for(var j=0;j<c.matrixIds.length;j++)c.options.resolutions[j]=c.matrixIds[j].scaleDenominator*2.8E-4;c.isBaseLayer=!0;c.name=a;c.options.maxExtent=h.contents.tileMatrixSets[e.matrixSet].bounds;c.maxExtent=c.options.maxExtent;c.projection=new OpenLayers.Projection(b.Extension[0].ProjectionCode[0]);
c.wrapDateLine=!1;map.addLayer(c);map.projection=c.projection;map.units=c.units;map.maxExtent=c.maxExtent;addLayerToList({ol:c,name:a,visible:!0});$("#layerslist").listview("refresh");map.zoomToMaxExtent();locate()},failure:function(){alert("Trouble getting capabilities doc")}})}
function mapguide(b){var d=Rfs.tema.MapAgent.toLowerCase().replace("mapagent/mapagent.fcgi","fusion")+"/layers/mapguide/php/";$.ajax({url:d+"createsession.php",data:{username:"Anonymous"},dataType:"jsonp",timeout:vent,success:function(c){$.ajax({url:d+"loadmap.php",type:"POST",data:{mapid:b.Extension[0].ResourceId[0],session:c.sessionId},dataType:"jsonp",timeout:vent,success:function(a){var c=OpenLayers.INCHES_PER_UNIT.m*a.metersPerUnit;OpenLayers.INCHES_PER_UNIT.dd=c;OpenLayers.INCHES_PER_UNIT.degrees=
c;OpenLayers.DOTS_PER_INCH=96;c=!0;b.Extension[0].Options&&b.Extension[0].Options[0].isBaseLayer&&b.Extension[0].Options[0].isBaseLayer[0]=="false"&&(c=!1);var d=!1;b.Extension[0].Options&&b.Extension[0].Options[0].useOverlay&&b.Extension[0].Options[0].useOverlay[0]=="true"&&(d=!0);var j=!0;b.SingleTile&&b.SingleTile[0]=="False"&&(j=!1);var f=!1;b.Extension[0].Options&&b.Extension[0].Options[0].useHttpTile&&b.Extension[0].Options[0].useHttpTile[0]=="true"&&(f=!0);var g="";b.Extension[0].Options&&
b.Extension[0].Options[0].format&&(g=b.Extension[0].Options[0].format[0]);b.Extension[0].ImageFormat&&(g=b.Extension[0].ImageFormat[0]);var k={isBaseLayer:c,useOverlay:d,useAsyncOverlay:!0,singleTile:j,useHttpTile:f,units:"m",maxExtent:new OpenLayers.Bounds.fromArray(a.extent)};f?(j={basemaplayergroupname:a.groups[0].groupName},g!=""&&(j.format=g),k.scales=a.FiniteDisplayScales,g=new OpenLayers.Layer.MapGuide(a.mapTitle,b.Extension[0].Options[0].tileCacheUrl[0].split(","),j,k)):(j?(map.projection=
"EPSG:"+a.epsg,j={mapname:a.mapName,session:a.sessionId,behavior:2},g!=""&&(j.format=g),k.maxResolution="auto",k.maxScale=1,k.minScale=1E12,k.units="m"):(j={mapdefinition:a.mapId,session:a.sessionId,basemaplayergroupname:a.groups[0].groupName},g!=""&&(j.format=g),k.scales=a.FiniteDisplayScales),g=new OpenLayers.Layer.MapGuide(a.mapTitle,Rfs.tema.MapAgent,j,k));map.addLayer(g);$("#map").css("background-color",a.backgroundColor);startLocate&&c&&map.zoomToExtent(g.maxExtent);d?(map.removeLayer(redline,
!1),map.removeLayer(vector,!1),map.removeLayer(crosshairsLayer,!1),map.addLayer(redline),map.addLayer(vector),map.addLayer(crosshairsLayer)):addLayerToList({ol:g,name:g.name,visible:!0});if(!f)for(c=0;c<a.layers.length;c++){d=a.layers[c];f=!0;if(!d.visible)f=!1,g.params.hideLayers=typeof g.params.hideLayers==="undefined"?d.id:g.params.hideLayers+","+d.id;d.displayInLegend&&addLayerToList({ol:g,name:d.legendLabel,id:d.uniqueId,visible:f})}$("#layerslist").listview("refresh")},error:function(a,b){alert(b)}})},
error:function(b,a){alert(a)}})}function fixContentHeight(){var b=$(window).height(),d=$("#headerKort"),c=$("#kortnavbar"),c=c.css("display")=="none"?b-d.outerHeight():b-c.outerHeight()-d.outerHeight();$("#map").css("height",c);$("#navigation").css("top",d.outerHeight()+10);window.map&&map.updateSize();$("#Photo").css("height",b);b=$("#photoButton");d=$(window).width();c=b.outerWidth();b.css("left",(d-c)/2)}
function addLayerToList(b){if(b.ol.isBaseLayer)map.projection=b.ol.projection.getCode();var d=$("<li>",{"data-icon":"check","class":b.ol.visibility&&b.visible?"checked":""}).append($("<a />",{text:b.name}).click(function(){if(b.ol.CLASS_NAME=="OpenLayers.Layer.MapGuide"&&typeof b.id!=="undefined"){d.toggleClass("checked");if(d.hasClass("checked")){if(typeof b.ol.params.hideLayers!=="undefined")b.ol.params.hideLayers=b.ol.params.hideLayers.replace(b.id,"").replace(",,",",");b.ol.params.showLayers=
typeof b.ol.params.showLayers==="undefined"?b.id:b.ol.params.showLayers+","+b.id}else{if(typeof b.ol.params.showLayers!=="undefined")b.ol.params.showLayers=b.ol.params.showLayers.replace(b.id,"").replace(",,",",");b.ol.params.hideLayers=typeof b.ol.params.hideLayers==="undefined"?b.id:b.ol.params.hideLayers+","+b.id}b.ol.redraw()}else b.ol.isBaseLayer&&b.name==b.ol.name?(map.projection=b.ol.projection.getCode(),map.maxExtent=b.maxExtent,map.units=b.units,map.setBaseLayer(b.ol)):b.ol.setVisibility(!b.ol.getVisibility())})).appendTo("#layerslist");
b.ol.events.on({visibilitychanged:function(){$(d).toggleClass("checked")}})};
