(!window.console||!console.log)&&function(){for(var c=function(){},a="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profileEnd,markTimeline,table,time,timeEnd,timeStamp,trace,warn".split(","),b=a.length,d=window.console={};b--;)d[a[b]]=c}();
Modernizr.load({test:Modernizr.inputtypes.date,yep:"js/vendor/date.js",nope:["css/jqm-datebox.css","js/vendor/jqm-datebox.core.js","js/vendor/jqm-datebox.mode.calbox.js","js/vendor/jquery.mobile.datebox.i18n.da.utf8.js","js/vendor/no-date.js"]});function html5Camera(){return!(!navigator.getUserMedia&&!navigator.webkitGetUserMedia&&!navigator.mozGetUserMedia&&!navigator.msGetUserMedia)}function html5File(){return window.File&&window.FileReader&&window.FileList&&window.Blob}
typeof cordova!="undefined"?Modernizr.load({load:"js/vendor/camera-cordova.js"}):html5File()||html5Camera()?Modernizr.load({load:"js/vendor/camera-html5.js"}):Modernizr.load({load:"js/vendor/camera.js"});
var url="http://service.rapportfrastedet.dk/RapportFraStedet/api/kommune.aspx",imageId,x=0,y=0;$(document).bind("mobileinit",function(){$.mobile.loadingMessageTextVisible=!0});
$("[data-role=page]").live("pageshow",function(b){try{var e=!1,d="";switch(b.currentTarget.id){case "AlleKommuner":document.title="Alle Kommuner";d="#AlleKommuner";e=!0;break;case "Kommune":document.title=Rfs.kommune.Navn;d="#Kommune?nr="+Rfs.kommune.Nr;e=!0;break;case "Kort":document.title=Rfs.kommune.Navn+" - "+Rfs.tema.Navn+" - Kort";d="#Tema?id="+Rfs.tema.Id+"&Nr="+Rfs.kommune.Nr;e=!0;break;case "Formular":document.title=Rfs.kommune.Navn+" - "+Rfs.tema.Navn;d="#Formular";e=!0;break;case "PhotoPage":document.title=
Rfs.kommune.Navn+" - "+Rfs.tema.Navn+" - Kamera",d="#PhotoPage",e=!0}e&&(_gaq.push(["_setAccount","UA-24623853-2"]),_gaq.push(["_trackPageview",d]))}catch(a){}});
$("[data-role=dialog]").live("pageshow",function(b){try{var e=!1,d="";switch(b.currentTarget.id){case "Start":document.title="Rapport Fra Stedet";d="";e=!0;break;case "Advarsel":document.title=Rfs.kommune.Navn+" - Advarsel";d="#Advarsel";e=!0;break;case "Progress":uploadCamera();break;case "Kvittering":document.title=Rfs.kommune.Navn+" - "+Rfs.tema.Navn+" - Kvittering",d="#Kvittering",e=!0}e&&(_gaq.push(["_setAccount","UA-24623853-2"]),_gaq.push(["_trackPageview",d]))}catch(a){}});
$(document).ready(function(){$(window).bind("resize orientationchange",function(){fixContentHeight()});Rfs.init();$.support.cors=!0});
function geoLocate(){x!=0&&y!=0?Rfs.showPosition():navigator.geolocation?($.mobile.showPageLoadingMsg("a","Finder position...",!1),navigator.geolocation.getCurrentPosition(function(b){$.mobile.hidePageLoadingMsg();x=b.coords.longitude;y=b.coords.latitude;Rfs.lat=b.coords.latitude;Rfs.lon=b.coords.longitude;Rfs.acc=b.coords.accuracy;var b=new Proj4js.Proj("EPSG:4326"),e=new Proj4js.Proj("EPSG:25832"),d=new Proj4js.Point(x,y);Proj4js.transform(b,e,d);x=d.x;y=d.y;Rfs.showPosition()},function(){$.mobile.hidePageLoadingMsg();
$.mobile.changePage("#AlleKommuner")},{enableHighAccuracy:!0,maximumAge:0,timeout:1E4})):$.mobile.changePage("#AlleKommuner",{transition:"slide"})}
$(document).bind("pageinit",function(b){if(b.target.id=="Start"){var e=$.mobile.path.parseUrl(window.location.href);e.hash.search(/^#Tema/)!==-1?(b.preventDefault(),Rfs.showTema(e,{})):e.hash.search(/^#Kommune/)!==-1?(b.preventDefault(),Rfs.showKommune(e,{})):Rfs.kommune?(b.preventDefault(),Rfs.showKommune(e,{})):$("#app").length>0&&(b=navigator.userAgent.toLowerCase(),b.indexOf("android")>-1?$("#app").html("<p>Installere Rapport Fra Stedet som app p\u00e5 din smartphone. Klik p\u00e5 nedenst\u00e5ende link.</p><a rel='external' data-ajax='false' href='http://www.rapportfrastedet.dk/RapportFraStedet.apk' ><img src='./img/android.png' alt='Android'/></a>"):
(b.indexOf("ipad")>-1||b.indexOf("iphone")>-1)&&$("#app").html("<p>Tilf\u00f8j Rapport Fra Stedet som genvej. Klik p\u00e5 <img src='./img/genvej.jpg' alt='genvej'/> i din browser og f\u00f8j til hjemmesk\u00e6rm."))}});
$(document).bind("pagebeforechange",function(b,e){if(typeof e.toPage==="string"){var d=$.mobile.path.parseUrl(e.toPage);d.hash.search(/^#Kommune/)!==-1?(b.preventDefault(),Rfs.showKommune(d,e.options)):d.hash.search(/^#AlleKommuner/)!==-1?(b.preventDefault(),Rfs.showAlleKommuner(d,e.options)):d.hash.search(/^#Tema/)!==-1?(b.preventDefault(),Rfs.showTema(d,e.options)):d.hash.search(/^#Advarsel/)!==-1?(b.preventDefault(),Rfs.showAdvarsel(d,e.options)):d.hash.search(/^#PhotoPage/)!==-1&&(b.preventDefault(),
imageId=d.hash.replace(/.*id=/,""),$.mobile.changePage($("#PhotoPage")))}else e.toPage.attr("id")=="Progress"&&e.options.fromPage.attr("id")!="Formular"&&(b.preventDefault(),$.mobile.changePage($("#Kommune")))});
var Rfs={url:null,mapSet:null,temaer:null,tema:null,rapport:null,kommuner:null,kommune:null,useDrawControl:!1,showMarker:!1,showInfo:!1,lat:0,lon:0,acc:0,ajaxCheck:null,init:function(){$("#Kommune").page();$("#AlleKommuner").page();$("#Formular").page();$("#Advarsel").page();$("#Kort").page()},showAlleKommuner:function(b,e){Rfs.kommuner==null?($.mobile.showPageLoadingMsg("a","Henter kommuner...",!1),$.ajax({url:url,dataType:"jsonp",success:function(b){Rfs.kommuner=b;Rfs.kommune=null;Rfs.tema=null;
Rfs.temaer=null;for(var a="",f=0;f<b.length;f++){var c=b[f];a+="<li";c.ModtagerIndberetning==0?(a+=" data-icon='alert'>",a+="<a href='#Advarsel?nr="+c.Nr+"' data-transition='slide'>"):a+="><a href='#Kommune?nr="+c.Nr+"' data-transition='slide'>";c.Logo!=""&&(a+="<img src='http://service.rapportfrastedet.dk/RapportFraStedet/Images/Kommuner/"+c.Logo+"' />");a+="<h1>"+c.Navn+"</h1>";c.ModtagerIndberetning==0&&(a+="<a href='#Advarsel?nr="+c.Nr+"' data-theme='e' data-transition='slide'></a>");a+="</a></li>"}b=
$("#AlleKommuner");f=b.children(":jqmData(role=content)");f.find("ul").html(a);f.find("ul").listview("refresh");$.mobile.changePage(b,e)},error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}})):$.mobile.changePage($("#AlleKommuner"),e)},showKommune:function(b,e){e.dataUrl=b.hash;var d=b.hash.replace(/.*nr=/,"");if(Rfs.kommune&&Rfs.kommune.Nr==d)Rfs.showThemes(b,e);else{Rfs.temaer=null;if(Rfs.kommuner!=null)for(var a=0;a<Rfs.kommuner.length;a++)if(Rfs.kommuner[a].Nr==
d){Rfs.kommune=Rfs.kommuner[a];break}Rfs.kommune==null?($.mobile.showPageLoadingMsg("a","Henter kommune...",!1),$.ajax({url:url,dataType:"jsonp",data:{nr:d},success:function(a){Rfs.kommune=a;Rfs.showThemes(b,e)},error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}})):Rfs.showThemes(b,e)}},showThemes:function(b,e){Rfs.tema=null;if(Rfs.temaer){var d=$("#Kommune");$.mobile.changePage(d,e)}else if(Rfs.kommune.ModtagerIndberetning)$.mobile.showPageLoadingMsg("a",
"Henter temaer...",!1),$.ajax({url:Rfs.kommune.URL+"/api/Tema.aspx",dataType:"jsonp",data:{nr:Rfs.kommune.Nr,x:x,y:y},success:function(a){Rfs.createKommune(a);a=$("#Kommune");$.mobile.changePage(a,e)},error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}});else{var d=$("#ModtagerIkkeIndberetning"),a=d.children(":jqmData(role=content)"),f="";f+="<h2>Du st\u00e5r i "+data.Navn+" Kommune</h2>";f+="<p>RapportFraStedet kan ikke indberette til denne kommune!</p>";
Rfs.kommune.Besked!=""&&(f+="<p>"+data.Besked+"</p>");data.URL!=""&&(f+="<a href='"+data.URL+"' rel='external' data-ajax='false' data-role='button'>Kontakt</a>");f+="<p>Du kan v\u00e6lge at indberette til en anden kommune.</p>";f+="<a href='#AlleKommuner' data-role='button' data-theme='b' >V\u00e6lg kommune</a>";a.html(f);d.trigger("create");$.mobile.changePage("#ModtagerIkkeIndberetning")}},createKommune:function(b){Rfs.temaer=b;var b=$("#Kommune"),e=b.children(":jqmData(role=header)"),d="",d=e.find("img");
d[0].src="http://service.rapportfrastedet.dk/RapportFraStedet/Images/Kommuner/"+Rfs.kommune.Logo;d[0].style.visibility=Rfs.kommune.Logo==""?"hidden":"visible";e.find("h1").html(Rfs.kommune.Navn+" Kommune");d="";for(e=0;e<Rfs.temaer.length;e++){var a=Rfs.temaer[e];d+="<li";a.ModtagerIndberetning==0&&(d+=" data-icon='alert'");d+="><a href='#Tema?id="+a.Id+"&nr="+Rfs.kommune.Nr+"' data-transition='slide'>";a.Logo!=""&&(d+="<img src='"+a.Logo+"' />");d+="<h1>"+a.Navn+"</h1><p>"+a.Beskrivelse+"</p>";a.ModtagerIndberetning==
0&&(d+="<a href='#Warning' data-theme='e' data-rel='dialog' data-transition='slide'></a>");d+="</a></li>"}e=b.children(":jqmData(role=content)");e.find("ul").html(d);e.find("ul").listview("refresh");b.page()},showTema:function(b,e){e.dataUrl=b.hash;Rfs.rapport=null;var d=b.hash.split("&"),a=d[0].replace(/.*id=/,""),d=d[1].replace(/.*nr=/,"");if(Rfs.kommune&&Rfs.kommune.Nr==d)if(Rfs.tema&&Rfs.tema.Id==a)Rfs.createTema(b,e);else{Rfs.tema=null;if(Rfs.temaer!=null)for(var f=0;f<Rfs.temaer.length;f++)if(Rfs.temaer[f].Id==
a&&Rfs.temaer[f].Nr==d){Rfs.tema=Rfs.temaer[f];break}Rfs.tema==null?($.mobile.showPageLoadingMsg("a","Henter tema...",!1),$.ajax({url:Rfs.kommune.URL+"/api/Tema.aspx",dataType:"jsonp",data:{nr:d,id:a},success:function(a){Rfs.tema=a;Rfs.createTema(b,e)},error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}})):Rfs.createTema(b,e)}else{if(Rfs.kommuner!=null)for(f=0;f<Rfs.kommuner.length;f++)if(Rfs.kommuner[f].Nr==d){Rfs.kommune=Rfs.kommuner[f];
break}Rfs.kommune==null?($.mobile.showPageLoadingMsg("a","Henter kommune...",!1),$.ajax({url:url,dataType:"jsonp",data:{nr:d},success:function(a){Rfs.kommune=a;Rfs.showTema(b,e)},error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}})):Rfs.showTema(b,e)}},createTema:function(b,e){if(Rfs.tema!=null){$.mobile.showPageLoadingMsg("a","Henter tema...",!1);$("#tegnList").html("<li data-role='divider' data-theme='a'>Tegnev\u00e6rkt\u00f8jer</li>");
var d=Rfs.tema.MapAgent.toLowerCase().replace("mapagent/mapagent.fcgi","fusion")+"/layers/mapguide/php/ApplicationDefinition.php?USERNAME=Anonymous&CLIENTAGENT=Rapport+Fra+Stedet+1.0.0&appid="+Rfs.tema.ApplicationDefinition;$.ajax({url:d,dataType:"jsonp",complete:function(){$.mobile.hidePageLoadingMsg()},error:function(){$.mobile.changePage("#ShowKommunerError")},success:function(a){Rfs.useDrawControl=!1;Rfs.showMarker=!1;$("#kortnavbar").hide();$("#backKommune").attr("href","#Kommune?nr="+Rfs.kommune.Nr);
if(a.ApplicationDefinition&&a.ApplicationDefinition.length>0&&a.ApplicationDefinition[0].MapSet&&a.ApplicationDefinition[0].MapSet.length>0){Rfs.mapSet=a.ApplicationDefinition[0].MapSet[0];oiorest.init();if(a.ApplicationDefinition[0].WidgetSet&&a.ApplicationDefinition[0].WidgetSet.length>0){for(widget in a.ApplicationDefinition[0].WidgetSet[0].Widget){var b=a.ApplicationDefinition[0].WidgetSet[0].Widget[widget];switch(b.Type[0]){case "RfsSearch":var c=b.Extension[0],d=new Search(widget,b.Name[0],
b.Disabled[0]=="false");d.placeholder1=c.placeholder1[0];d.url1=c.url1[0].replace(/%26/gi,"&");d.id1=c.id1[0];d.name1=c.name1[0];d.chars1=c.chars1[0];d.title1=c.title1[0];if(c.placeholder2)d.placeholder2=c.placeholder2[0];if(c.url2)d.url2=c.url2[0].replace(/%26/gi,"&");if(c.id2)d.id2=c.id2[0];if(c.name2)d.name2=c.name2[0];if(c.chars2)d.chars2=c.chars2[0];if(c.title2)d.title2=c.title2[0];if(c.placeholder3)d.placeholder3=c.placeholder3[0];if(c.url3)d.url3=c.url3[0].replace(/%26/gi,"&");if(c.id3)d.id3=
c.id3[0];if(c.name3)d.name3=c.name3[0];if(c.chars3)d.chars3=c.chars3[0];if(c.title3)d.title3=c.title3[0];d.url=c.url[0].replace(/%26/gi,"&");d.x1=c.x1[0];d.y1=c.y1[0];d.projection=c.projection[0];oiorest.items.push(d);break;case "RapportFraStedet":$("#kortnavbar").show();c=b.Extension[0];if(c.type[0]!="-1"&&c.type[0]!="0")$("#tegnList").html("<li data-role='divider' data-theme='a'>Tegnev\u00e6rkt\u00f8jer</li>"),Rfs.useDrawControl=!0;if(c.type[0]=="-1")Rfs.showMarker=!1;if(c.type[0]=="-1")Rfs.showMarker=
!0;(c.type[0]=="1"||c.type[0]=="3"||c.type[0]=="5"||c.type[0]=="7")&&$("<li id='tegnPunkt' data-icon='check'><a href='#' data-rel='back' onclick='Point()'>Punkt</a></li>").appendTo("#tegnList");(c.type[0]=="2"||c.type[0]=="3"||c.type[0]=="6"||c.type[0]=="7")&&$("<li id='tegnLinie' data-icon='check'><a href='#' data-rel='back' onclick='Path()'>Linie</a></li>").appendTo("#tegnList");(c.type[0]=="4"||c.type[0]=="5"||c.type[0]=="6"||c.type[0]=="7")&&$("<li id='tegnPolygon' data-icon='check'><a href='#' data-rel='back' onclick='Polygon()'>Polygon</a></li>").appendTo("#tegnList");
c.type[0]!="-1"&&c.type[0]!="0"&&($("<li id='tegnRediger' data-icon='check'><a href='#' data-rel='back' onclick='Modify()'>Rediger</a></li>").appendTo("#tegnList"),$("<li id='tegnNaviger' data-icon='check' class='checked'><a href='#' data-rel='back' onclick='Navigate()'>Naviger</a></li>").appendTo("#tegnList"),$("#tegnList").listview("refresh"));if(c.Url)Rfs.url=c.Url[0]}}$("#Kort");a=$("#headerKort").html("");$("<a data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-a' data-theme='a' data-icon='locate' onclick='locate()' >Position</a>").button().appendTo(a);
oiorest.items.length>0?($("<a data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-b' data-theme='a' href='#SearchPage1' data-icon='search' >S\u00f8g</a>").button().appendTo(a),Rfs.useDrawControl?($("<a data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c' data-theme='a' href='#Tegn' data-icon='star' data-rel='popup' data-position-to='window' >Tegn</a>").button().appendTo(a),$("<a data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-d' data-theme='a' href='#layerspage' data-icon='layers' data-rel='popup' data-position-to='window' >Kort</a>").button().appendTo(a),
a.removeClass("ui-grid-a"),a.removeClass("ui-grid-b"),a.addClass("ui-grid-c")):($("<a data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c' data-theme='a' href='#layerspage' data-icon='layers' data-rel='popup' data-position-to='window' >Kort</a>").button().appendTo(a),a.removeClass("ui-grid-a"),a.removeClass("ui-grid-c"),a.addClass("ui-grid-b"))):Rfs.useDrawControl?($("<a data-theme='a' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c' href='#Tegn' data-icon='star' data-rel='popup' data-position-to='window' >Tegn</a>").button().appendTo(a),
$("<a data-theme='a' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-d' href='#layerspage' data-icon='layers' data-rel='popup' data-position-to='window' >Kort</a>").button().appendTo(a),a.removeClass("ui-grid-a"),a.removeClass("ui-grid-c"),a.addClass("ui-grid-b")):($("<a data-theme='a' data-role='button' data-mini='true' data-corners='false' data-iconpos='top' class='ui-block-c' href='#layerspage' data-icon='layers' data-rel='popup' data-position-to='window' >Kort</a>").button().appendTo(a),
a.removeClass("ui-grid-b"),a.removeClass("ui-grid-c"),a.addClass("ui-grid-a"));if(oiorest.items.length>1){$("#searchOptionsDiv").html("<fieldset id='searchOptions' data-role='controlgroup'><legend>S\u00f8gemuligheder</legend></fieldset>");for(d in oiorest.items)oiorest.items[d].createCheckBox();$("#SearchPage1").trigger("create")}else $("#searchOptionsDiv").html("")}Rfs.url?(d=Rfs.url.replace("Data.aspx/Index","api/DataApi.aspx"),Rfs.url=Rfs.url.substr(0,Rfs.url.indexOf("/Data.aspx/Index")),$.mobile.showPageLoadingMsg("a",
"Henter formular...",!1),$.ajax({url:d,dataType:"jsonp",success:function(a){Rfs.createform(a,e)},error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}})):(createMap(),$.mobile.changePage("#Kort",e))}}})}},createform:function(b,e){Rfs.rapport=b;var d=b.Felter,a=$("#Formular").children(":jqmData(role=header)"),f=a.find("img");f[0].src=Rfs.tema.Logo;f[0].style.visibility=Rfs.tema.Logo==""?"hidden":"visible";a.find("h1").html(Rfs.tema.Navn);a="<input type='hidden' name='FormId' value='"+
Rfs.rapport.FormId+"'/>";a+="<input type='hidden' name='UniqueId' value='"+Rfs.rapport.UniqueId+"'/>";a+="<input type='hidden' name='ItemId' value='"+Rfs.rapport.ItemId+"'/>";a+="<input type='hidden' name='ViewId' value='"+Rfs.rapport.ViewId+"'/>";a+="<input type='hidden' name='UserId' value='"+Rfs.rapport.UserId+"'/>";a+="<input type='hidden' name='Date' value='"+Rfs.rapport.Date+"'/>";a+="<fieldset>";for(f=0;f<d.length;f++){var c=d[f];if(!c.Data)c.Data="";if(c.Permission==0)switch(handled=!0,c.TypeId){case 16:a+=
"<input type='hidden' name='Geometri' value='"+c.Data+"' id='Geometri'";c.Required==1&&(a+=" class=required");a+="/>";break;case 17:a+="<input type='hidden' name='Position' value='"+c.Data+"' id='Position'";c.Required==1&&(a+=" class=required");a+="/>";break;case 18:a+="<input type='hidden' name='Accuracy' value='"+c.Data+"' id='Accuracy'";c.Required==1&&(a+=" class=required");a+="/>";break;default:a+="<input type='hidden' name='"+c.Id+"' value='"+c.Data+"' id='"+c.Id+"'",c.Required==1&&(a+=" class=required"),
a+="/>"}else switch(c.TypeId){case 1:a+="<div data-role='fieldcontain'>";a+="<label for='"+c.Id+"'>"+c.Name+"</label>";a+="</div>";break;case 2:a+="<div data-role='fieldcontain'>";a+="<label for='"+c.Id+"'>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<input type='text' id='"+c.Id+"' name='"+c.Id+"' value='"+c.Data+"'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=" />";a+="</div>";break;case 3:a+="<div data-role='fieldcontain'>";a+="<label for='"+
c.Id+"'>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<select id='"+c.Id+"' name='"+c.Id+"' value='"+c.Data+"'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=">";a+="<option data-placeholder='true'>-- V\u00e6lg --</option>";for(var k=c.Selections,j=0;j<k.length;j++){var g=k[j];a+="<option value='"+g.Name+"'";g.Selected==1&&(a+=" selected='selected'");a+=">"+g.Name+"</option>"}a+="</select>";a+="</div>";break;case 4:a+="<div data-role='fieldcontain'>";
a+="<fieldset data-role='controlgroup'><legend>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</legend>";k=c.Selections;for(j=0;j<k.length;j++)g=k[j],a+="<input type='radio' id='"+g.Id+"' name='"+c.Id+"' value='"+g.Name+"'",g.Selected==1&&(a+=" checked='checked'"),c.Required==1&&(a+=" class=required"),c.Permission==1&&(a+=" disabled='disabled'"),a+="/><label for='"+g.Id+"'>"+g.Name+"</label>";a+="</fieldset>";a+="</div>";break;case 5:a+="<div data-role='fieldcontain'>";a+="<label for='"+c.Id+"'>";
c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<textarea id='"+c.Id+"' name='"+c.Id+"'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=">";a+=c.Data;a+="</textarea>";a+="</div>";break;case 6:a+="<div data-role='fieldcontain'>";a+="<fieldset data-role='controlgroup'><legend>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</legend>";a+="<input type='checkbox' id='"+c.Id+"' name='"+c.Id+"'";c.Data=="true"&&(a+=" checked='checked'");c.Required==1&&(a+=" class=required");
c.Permission==1&&(a+=" disabled='disabled'");a+=" /><label for='"+c.Id+"'>"+c.Name+"</label>";a+="</fieldset>";a+="</div>";break;case 7:a+="<div data-role='fieldcontain'>";a+="<label for='"+c.Id+"'>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<input type='email' id='"+c.Id+"' name='"+c.Id+"' value='"+c.Data+"'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=" />";a+="</div>";break;case 8:a+=markupCamera(c);break;case 10:a+=markupDate(c);break;
case 12:a+="<div data-role='fieldcontain'>";a+="<fieldset data-role='controlgroup'><legend>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</legend>";a+="<input type='checkbox' id='"+c.Id+"' name='"+c.Id+"'";c.Data=="true"&&(a+=" checked='checked'");c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=" /><label for='"+c.Id+"'>"+c.Name+"</label>";a+="</fieldset>";a+="</div>";break;case 13:a+="<div data-role='fieldcontain'>";a+="<fieldset data-role='controlgroup'><legend>";
c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</legend>";a+="<input type='checkbox' id='"+c.Id+"' name='"+c.Id+"'";c.Data=="true"&&(a+=" checked='checked'");c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=" /><label for='"+c.Id+"'>"+c.Name+"</label>";a+="</fieldset>";a+="</div>";break;case 14:a+="<div data-role='fieldcontain'>";a+="<a data-role='button' data-inline='true' href='"+c.Data+"'>"+c.Name+"</a>";a+="</div>";break;case 15:a+="<div data-role='fieldcontain'>";
a+="<label for='"+c.Id+"'>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<input type='text' id='"+c.Id+"' name='"+c.Id+"' value='"+c.Data+"'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=" />";a+="</div>";break;case 16:a+="<div data-role='fieldcontain'>";a+="<label for='Geometri'>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<textarea id='Geometri' name='Geometri'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");
a+=">";a+=c.Data;a+="</textarea>";a+="</div>";break;case 17:a+="<div data-role='fieldcontain'>";a+="<label for='Position'>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<textarea id='Position' name='Position'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=">";a+=c.Data;a+="</textarea>";a+="</div>";break;case 18:a+="<div data-role='fieldcontain'>";a+="<label for='Accuracy'>";c.Required==1&&(a+="<em>*</em>");a+=c.Name+"</label>";a+="<input type='text' id='Accuracy' name='Accuracy' value='"+
c.Data+"'";c.Required==1&&(a+=" class=required");c.Permission==1&&(a+=" disabled='disabled'");a+=" />";a+="</div>";break;case 22:a+="<hr />";break;case 23:a+="<h1>"+c.Name+"</h1>";break;case 24:a+="<p>"+c.Name+"</p>"}}a+="</fieldset>";$("#rapportForm").html(a).trigger("create");$(":file").bind("change",this.inputChanged);$("#rapportForm").validate();Rfs.showInfo=!0;createMap();$.mobile.changePage("#Kort",e)},inputChanged:function(){imageId=this.name;if(html5File()){var b=this.files[0];if(b.type.match("image.*")){var e=
new FileReader;e.onload=function(){return function(b){$("#A"+imageId).attr("src",b.target.result).css("display","inline").removeClass("imageCamera")}}(b);e.readAsDataURL(b)}}else $("#A"+imageId).val(this.value).css("display","inline-block")},showPosition:function(){$.mobile.showPageLoadingMsg("a","Henter temaer...",!1);$.ajax({url:url,dataType:"jsonp",data:{x:x,y:y},success:function(b){Rfs.kommune=b;if(b.ModtagerIndberetning)$.mobile.changePage("#Kommune?nr="+b.Nr);else{var e=$("#ModtagerIkkeIndberetning"),
d=e.children(":jqmData(role=content)"),a="";a+="<h2>Du st\u00e5r i "+b.Navn+" Kommune</h2>";a+="<p>RapportFraStedet kan ikke indberette til denne kommune!</p>";Rfs.kommune.Besked!=""&&(a+="<p>"+b.Besked+"</p>");b.URL!=""&&(a+="<a href='"+b.URL+"' rel='external' data-ajax='false' data-role='button'>Kontakt</a>");a+="<p>Du kan v\u00e6lge at indberette til en anden kommune.</p>";a+="<a href='#AlleKommuner' data-role='button' data-theme='b' >V\u00e6lg kommune</a>";d.html(a);e.trigger("create");$.mobile.changePage("#ModtagerIkkeIndberetning")}},
error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}})},Validate:function(){$("#rapportForm").valid()&&$("#Confirm").popup("open",{positionTo:"window",transition:"pop"})},showAdvarsel:function(b,e){var d=b.hash.replace(/.*nr=/,"");if(Rfs.kommuner!=null)for(var a=0;a<Rfs.kommuner.length;a++)if(Rfs.kommuner[a].Nr==d){Rfs.kommune=Rfs.kommuner[a];break}Rfs.kommune!=null&&(d=$("#Advarsel"),a="",a+="<h2>"+Rfs.kommune.Navn+" Kommune</h2>",a+="<p>Rapport Fra Stedet kan ikke indberette til denne kommune!</p>",
Rfs.kommune.Besked!=""&&(a+="<p>"+Rfs.kommune.Besked+"</p>"),Rfs.kommune.URL!=""&&(a+="<a href='"+Rfs.kommune.URL+"' rel='external' data-ajax='false' data-role='button'>Kontakt</a>"),a+="<p>Du kan v\u00e6lge at indberette til en anden kommune.</p>",a+="<a href='#AlleKommuner' data-role='button' data-theme='b' >V\u00e6lg kommune</a>",$("#update").html(a),d.trigger("create"),$.mobile.changePage(d,e))},checkIndberetning:function(){Rfs.ajaxCheck!=null&&Rfs.ajaxCheck.abort();var b=$("#Position");b.length>
0&&Rfs.lon&&Rfs.lat&&b.val("POINT("+Rfs.lon+" "+Rfs.lat+")");b=$("#Accuracy");b.length>0&&Rfs.acc&&b.val(Rfs.acc);b=$("#Geometri");b.length>0?($.mobile.showPageLoadingMsg("a","Validerer placering...",!1),Rfs.ajaxCheck=$.ajax({url:Rfs.url+"/api/Tema.aspx",dataType:"jsonp",data:{id:Rfs.tema.Id,geometri:b.val()},success:function(b){b==!0?$.mobile.changePage($("#Formular"),{transition:"slide"}):$("#GeometryError").popup("open")},error:function(){$.mobile.changePage("#ShowKommunerError")},complete:function(){$.mobile.hidePageLoadingMsg()}})):
(b=$("#Geometri"),b.length>0?b.hasClass("required")?$("#GeometryError").popup("open"):$.mobile.changePage($("#Formular"),{transition:"slide"}):$.mobile.changePage($("#Formular"),{transition:"slide"}))}},kommuneNr=null;$("#SearchPage1").live("pageinit",function(){$("#search1").bind("keyup change",function(){var b=$(this).val();oiorest.search(b)})});$("#OioVej").live("pageinit",function(){});
var oiorest={kommuneNr:null,kommuner:null,vejNr:null,ajax:[],items:null,activeSearch:null,search:function(b){for(var e=0;e<this.items.length;e++)if(this.items[e].text1!=b)this.items[e].text1=b,this.items[e].search1()},init:function(){$("#searchOptions>.ui-controlgroup-controls").html("");$("#searchResult1").html("");this.items=[];$("#SearchPage1").page();$("#SearchPage2").page();$("#SearchPage3").page();$("#searchInput2").bind("keyup change",function(){var b=$(this).val();if(b.length>=oiorest.activeSearch.chars2&&
oiorest.activeSearch.text2!=b)oiorest.activeSearch.text2=b,oiorest.activeSearch.search2()});$("#searchInput3").bind("keyup change",function(){var b=$(this).val();if(b.length>=oiorest.activeSearch.chars3&&oiorest.activeSearch.text3!=b)oiorest.activeSearch.text3=b,oiorest.activeSearch.search3()})}};
Search=function(b,e,d){this.id=b;this.title=e;this.checked=d;this.chars3=this.chars2=this.chars1=this.placeholder3=this.placeholder2=this.placeholder1=this.name3=this.name2=this.name1=this.id3=this.id2=this.id1=this.url3=this.url2=this.url1=this.title3=this.title2=this.title1=this.projection=this.url=this.y2=this.x2=this.y1=this.x1=this.ajax=null;this.text3=this.text2=this.text1="";this.selection3=this.selection2=this.selection1=null;var a=this;$("<ul>",{id:"searchList"+this.id,"data-role":"listview",
"data-inset":"true","data-count-theme":"b"}).appendTo("#searchResult1").listview();this.createCheckBox=function(){var b=$("<input>",{name:"searchOption"+this.id,id:"searchOption"+this.id,type:"checkbox"});a.checked&&b.attr("checked","checked");b.bind("change",function(b){a.checked=b.target.checked;a.checked?a.search1():$("#searchList"+a.id).html("")});b.appendTo("#searchOptions");$("<label>",{"for":"searchOption"+a.id,text:this.title}).appendTo("#searchOptions")};this.search1=function(){if(a.checked&&
($("#searchList"+a.id).html(""),a.text1.length>=a.chars1))a.ajax!=null&&a.ajax.abort(),$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1),a.ajax=$.ajax({url:a.url1.replace("[text]",a.text1).replace("[kommune]",Rfs.kommune.Nr),dataType:"jsonp",success:function(b){$("<li data-role='list-divider'>"+a.title1+"<span class='ui-li-count'>"+b.length+"</span></li>").appendTo("#searchList"+a.id);for(var c=0;c<b.length;c++){for(var d=a.name1,e=a.name1.match(/\[.+?\]/g);e.length;)var g=e.shift(),h=getPath(b[c],
g.replace("[","").replace("]","")),d=d.replace(g,h);a.addItem1(getPath(b[c],a.id1),d)}$("#searchList"+a.id).listview("refresh")},complete:function(){$.mobile.hidePageLoadingMsg()}})};this.search2=function(){$("#searchResult2").html("");a.ajax!=null&&a.ajax.abort();$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1);a.ajax=$.ajax({url:a.url2.replace("[text]",a.text2).replace("[kommune]",Rfs.kommune.Nr).replace("[selection1]",a.selection1),dataType:"jsonp",success:function(b){for(var c=0;c<b.length;c++){for(var d=
a.name2,e=a.name2.match(/\[.+?\]/g);e.length;)var g=e.shift(),h=getPath(b[c],g.replace("[","").replace("]","")),d=d.replace(g,h);a.addItem2(getPath(b[c],a.id2),d)}$("#searchResult2").listview("refresh")},complete:function(){$.mobile.hidePageLoadingMsg()}})};this.search3=function(){$("#searchResult3").html("");a.ajax!=null&&a.ajax.abort();$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1);a.ajax=$.ajax({url:a.url3.replace("[text]",a.text3).replace("[kommune]",Rfs.kommune.Nr).replace("[selection1]",
a.selection1).replace("[selection2]",a.selection2),dataType:"jsonp",success:function(b){for(var c=0;c<b.length;c++){for(var d=a.name3,e=a.name3.match(/\[.+?\]/g);e.length;)var g=e.shift(),h=getPath(b[c],g.replace("[","").replace("]","")),d=d.replace(g,h);a.addItem3(getPath(b[c],a.id3),d)}$("#searchResult3").listview("refresh")},complete:function(){$.mobile.hidePageLoadingMsg()}})};this.addItem1=function(b,c){$("<li>").append($("<a />",{text:c}).click(function(){oiorest.activeSearch=a;a.selection1=
b;a.url2?($("#SearchPage2").children(":jqmData(role=header)").find("h1").html(a.title2),$("#searchInput2").val(""),$("#searchInput2").attr("placeholder",a.placeholder2),$("#searchResult2").html(""),a.chars2>0?$("#searchHint2").html("Indtast minimum "+a.chars2+" karakterer!"):($("#searchHint2").html(""),a.text2="",a.search2()),$.mobile.changePage("#SearchPage2")):a.getPosition(c)})).appendTo("#searchList"+a.id)};this.addItem2=function(b,c){$("<li>").append($("<a />",{text:c}).click(function(){oiorest.activeSearch=
a;a.selection2=b;if(a.url3){var d=$("#SearchPage3");d.children(":jqmData(role=header)").find("h1").html(a.title3);$("#searchInput3").val("");$("#searchInput3").attr("placeholder",a.placeholder3);$("#searchResult3").html("");a.chars3>0?$("#searchHint3").html("Indtast minimum "+a.chars3+" karakterer!"):($("#searchHint3").html(""),a.text3="",a.search3());$.mobile.changePage(d)}else a.getPosition(c)})).appendTo("#searchResult2")};this.addItem3=function(b,c){$("<li>").append($("<a />",{text:c}).click(function(){oiorest.activeSearch=
a;a.selection3=b;a.getPosition(c)})).appendTo("#searchResult3")};this.getPosition=function(b){a.ajax!=null&&a.ajax.abort();$.mobile.showPageLoadingMsg("a","S\u00f8ger...",!1);a.ajax=$.ajax({url:a.url.replace("[text]",b).replace("[kommune]",Rfs.kommune.Nr).replace("[selection1]",a.selection1).replace("[selection2]",a.selection2).replace("[selection3]",a.selection3),dataType:"jsonp",success:function(b){var d=null;try{d=map.projection.getCode()}catch(e){d=map.projection}var f=null,f=d=="ETRS89.UTM-32N"?
new OpenLayers.Projection("EPSG:25832"):map.projection;a.x2?(d=new OpenLayers.Geometry.Point(getPath(b,a.x1),getPath(b,a.y1)),b=new OpenLayers.Geometry.Point(getPath(b,a.x2),getPath(b,a.y2)),d.transform(new OpenLayers.Projection(a.projection),mapPojection),b.transform(new OpenLayers.Projection(a.projection),f),f=new OpenLayers.Bounds(d.x,d.y,b.x,b.y),map.zoomToExtent(f)):(b=new OpenLayers.Geometry.Point(getPath(b,a.x1),getPath(b,a.y1)),b.transform(new OpenLayers.Projection(a.projection),f),vector.removeAllFeatures(),
vector.addFeatures([new OpenLayers.Feature.Vector(b,{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10})]),map.zoomToExtent(vector.getDataExtent()));f=$("#Kort");$.mobile.changePage(f)},complete:function(){$.mobile.hidePageLoadingMsg()}})}};function getPath(b,e){b.length>0&&(b=b[0]);for(var d=e.split(".");d.length&&b;)b=b[d.shift()];return b}
var apiKey="AuNxzdIgj_DsnHh_sCAkkhlwPbfe1B-m890rn4sjfAG1niRi3lCjtxunctjRCn-Q",map,activeControl,pointControl,pathControl,polygonControl,modifyControl,removeControl,navigationControl,redline,vector,crosshairsLayer,crosshairMarker,icon,geolocate,startLocate;
function Point(){$("#tegnPunkt").addClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=pointControl;activeControl.activate()}
function Path(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").addClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=pathControl;activeControl.activate()}
function Polygon(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").addClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=polygonControl;activeControl.activate()}
function Modify(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").addClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").removeClass("checked");activeControl&&activeControl.deactivate();activeControl=modifyControl;activeControl.activate()}
function Navigate(){$("#tegnPunkt").removeClass("checked");$("#tegnLinie").removeClass("checked");$("#tegnPolygon").removeClass("checked");$("#tegnRediger").removeClass("checked");$("#tegnSlet").removeClass("checked");$("#tegnNaviger").addClass("checked");activeControl&&activeControl.deactivate();activeControl=null}
function Move(){if(Rfs.showMarker){var b=map.getExtent();crosshairMarker&&crosshairsLayer.removeMarker(crosshairMarker);crosshairMarker=new OpenLayers.Marker(new OpenLayers.LonLat(b.left+(b.right-b.left)/2,b.bottom+(b.top-b.bottom)/2),icon);crosshairsLayer.addMarker(crosshairMarker);if(Rfs.rapport&&Rfs.rapport.SRS){var e=$("#Geometri");if(e.length>0){var d=null;try{d=map.projection.getCode()}catch(a){d=map.projection}var f=null,f=d=="ETRS89.UTM-32N"?new OpenLayers.Projection("EPSG:25832"):map.projection,
d=new OpenLayers.Projection(Rfs.rapport.SRS),b=new OpenLayers.Geometry.Point(b.left+(b.right-b.left)/2,b.bottom+(b.top-b.bottom)/2);b.transform(f,d);e.val(b.toString())}}}}
function initMap(){startLocate=!0;crosshairsLayer=new OpenLayers.Layer.Markers("Crosshairs Layer");vector=new OpenLayers.Layer.Vector("Vector Layer",{});var b=new OpenLayers.Size(100,100),e=new OpenLayers.Pixel(-50,-50);icon=new OpenLayers.Icon("./img/crosshair.png",b,e);redline=new OpenLayers.Layer.Vector("Redline Layer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{pointRadius:20,graphicName:"circle",fillColor:"white",fillOpacity:0.25,
strokeWidth:3,strokeOpacity:1,strokeColor:"#ff6600"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#ff6600"},Polygon:{strokeWidth:3,strokeOpacity:1,fillColor:"#ff6600",strokeColor:"#ff6600"}}})]}),select:new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{pointRadius:20,graphicName:"circle",fillColor:"white",fillOpacity:0.25,strokeWidth:3,strokeOpacity:1,strokeColor:"#ff9900"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#ff9900"},Polygon:{strokeWidth:3,strokeOpacity:1,
fillColor:"#ff9900",strokeColor:"#ff9900"}}})]}),temporary:new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:{graphicName:"circle",pointRadius:20,fillColor:"white",fillOpacity:0.25,strokeWidth:3,strokeColor:"#ff3300"},Line:{pointRadius:20,strokeWidth:3,strokeOpacity:1,strokeColor:"#ff3300"},Polygon:{strokeWidth:3,strokeOpacity:1,strokeColor:"#ff3300",fillColor:"#ff3300"}}})]})})});redline.events.register("beforefeatureadded",this,function(a){redline.removeAllFeatures();if(Rfs.rapport&&
Rfs.rapport.SRS){var b=$("#Geometri");if(b.length>0){var c=null;try{c=map.projection.getCode()}catch(d){c=map.projection}var e=null,e=c=="ETRS89.UTM-32N"?new OpenLayers.Projection("EPSG:25832"):map.projection,c=new OpenLayers.Projection(Rfs.rapport.SRS),a=a.feature.geometry.clone();a.transform(e,c);b.val(a.toString())}}});modifyControl=new OpenLayers.Control.ModifyFeature(redline);pointControl=new OpenLayers.Control.DrawFeature(redline,OpenLayers.Handler.Point);pathControl=new OpenLayers.Control.DrawFeature(redline,
OpenLayers.Handler.Path);polygonControl=new OpenLayers.Control.DrawFeature(redline,OpenLayers.Handler.Polygon);navigationControl=new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:!0}});geolocate=new OpenLayers.Control.Geolocate({id:"locate-control",geolocationOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1E4}});var d={fillOpacity:0.1,fillColor:"#000",strokeColor:"#f00",strokeOpacity:0.6};geolocate.events.register("locationfailed",this,function(a){var b="<p>";switch(a.error.code){case 1:b+=
"Det er ikke tilladt at bruge GPS enheden";break;case 2:b+="Der kunne ikke opn\u00e5s en position";break;case 3:b+="Der skete en timeout ved bestemmelse af positionen"}b+="</p><p>"+a.error.message+"</p>";$("#LocationErrorMessage").html(b);$("#LocationError").popup("open")});geolocate.events.register("locationupdated",this,function(a){Rfs.lat=a.position.coords.latitude;Rfs.lon=a.position.coords.longitude;Rfs.acc=a.position.coords.accuracy;vector.removeAllFeatures();vector.addFeatures([new OpenLayers.Feature.Vector(a.point,
{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,50,0),{},d)]);map.zoomToExtent(vector.getDataExtent());Rfs.useDrawControl||vector.removeAllFeatures()});map=new OpenLayers.Map({div:"map",theme:null,controls:[geolocate,pointControl,pathControl,polygonControl,modifyControl,navigationControl],layers:[redline,
vector,crosshairsLayer],eventListeners:{move:Move}});$("#plus").click(function(){map.zoomIn()});$("#minus").click(function(){map.zoomOut()});$(window).bind("resize orientationchange",function(){fixContentHeight()});map.events.register("zoomend",this,function(){startLocate&&(startLocate=!1,locate())});createMap()}function locate(){geolocate.active?geolocate.getCurrentLocation():geolocate.activate()}
function createMap(){if(map&&Rfs.mapSet){geolocate.deactivate();startLocate=!0;crosshairMarker&&crosshairsLayer.removeMarker(crosshairMarker);redline.removeAllFeatures();Navigate();$("#layerslist").html("<li data-role='divider' data-theme='a'>Baggrundskort</li>");var b=map.layers.length;for(i=0;i<b;i++)map.removeLayer(map.layers[0],!1);map.addLayer(redline);map.addLayer(vector);map.addLayer(crosshairsLayer);b=!1;for(mapGroupItem in Rfs.mapSet.MapGroup)for(mapItem in Rfs.mapSet.MapGroup[mapGroupItem].Map){var e=
Rfs.mapSet.MapGroup[mapGroupItem].Map[mapItem];switch(e.Type[0]){case "WMTS":wmts(e);break;case "MapGuide":mapguide(e);break;case "OpenStreetMap":b=new OpenLayers.Layer.OSM(e.Extension[0].Options[0].name[0]);map.addLayer(b);addLayerToList({ol:b,name:b.name});b=!0;break;case "Google":var d=e.Extension[0].Options[0].name[0];switch(e.Extension[0].Options[0].type[0]){case "G_PHYSICAL_MAP":case "TERRAIN":b=new OpenLayers.Layer.Google(d,{type:google.maps.MapTypeId.TERRAIN});map.addLayer(b);addLayerToList({ol:b,
name:b.name});b=!0;break;case "G_HYBRID_MAP":case "HYBRID":b=new OpenLayers.Layer.Google(d,{type:google.maps.MapTypeId.HYBRID});map.addLayer(b);addLayerToList({ol:b,name:b.name});b=!0;break;case "G_SATELLITE_MAP":case "SATELLITE":b=new OpenLayers.Layer.Google(d,{type:google.maps.MapTypeId.SATELLITE});map.addLayer(b);addLayerToList({ol:b,name:b.name});b=!0;break;case "G_NORMAL_MAP":case "ROADMAP":b=new OpenLayers.Layer.Google(d,{type:google.maps.MapTypeId.ROADMAP}),map.addLayer(b),addLayerToList({ol:b,
name:b.name}),b=!0}break;case "VirtualEarth":switch(d=e.Extension[0].Options[0].name[0],e.Extension[0].Options[0].type[0]){case "Road":b=new OpenLayers.Layer.Bing({key:apiKey,type:"Road",metadataParams:{mapVersion:"v1"},name:d});map.addLayer(b);addLayerToList({ol:b,name:b.name});b=!0;break;case "Aerial":b=new OpenLayers.Layer.Bing({key:apiKey,type:"Aerial",name:d});map.addLayer(b);addLayerToList({ol:b,name:b.name});b=!0;break;case "Hybrid":b=new OpenLayers.Layer.Bing({key:apiKey,type:"AerialWithLabels",
name:d}),map.addLayer(b),addLayerToList({ol:b,name:b.name}),b=!0}}}b&&($("#layerslist").listview("refresh"),map.zoomToMaxExtent())}}
function wmts(b){OpenLayers.ProxyHost="proxy.cgi?url=";var e=b.Extension[0].Options[0].url[0].replace(/%26/gi,"&");OpenLayers.Request.GET({url:e,params:{SERVICE:"WMTS",VERSION:"1.0.0",REQUEST:"GetCapabilities"},success:function(d){OpenLayers.ProxyHost=null;var a={layer:b.Extension[0].Options[0].layer[0],matrixSet:b.Extension[0].Options[0].matrixSet[0],style:b.Extension[0].Options[0].style[0],url:e,units:b.Extension[0].Options[0].units[0]},f=d.responseXML;if(!f||!f.documentElement)f=d.responseText;
d=new OpenLayers.Format.WMTSCapabilities;f=d.read(f);d=d.createLayer(f,a);d.options.resolutions=Array(d.matrixIds.length);for(var c=0;c<d.matrixIds.length;c++)d.options.resolutions[c]=d.matrixIds[c].scaleDenominator*2.8E-4;d.options.maxExtent=f.contents.tileMatrixSets[a.matrixSet].bounds;d.maxExtent=d.options.maxExtent;d.projection=new OpenLayers.Projection(b.Extension[0].ProjectionCode[0]);d.wrapDateLine=!1;map.addLayer(d);map.projection=d.projection;map.units=d.units;map.maxExtent=d.maxExtent;addLayerToList({ol:d,
name:d.name});$("#layerslist").listview("refresh");map.zoomToMaxExtent();locate()},failure:function(){alert("Trouble getting capabilities doc")}})}
function mapguide(b){var e=Rfs.tema.MapAgent.toLowerCase().replace("mapagent/mapagent.fcgi","fusion")+"/layers/mapguide/php/";$.ajax({url:e+"createsession.php",data:{username:"Anonymous"},dataType:"jsonp",success:function(d){$.ajax({url:e+"loadmap.php",type:"POST",data:{mapid:b.Extension[0].ResourceId[0],session:d.sessionId},dataType:"jsonp",success:function(a){var d=OpenLayers.INCHES_PER_UNIT.m*a.metersPerUnit;OpenLayers.INCHES_PER_UNIT.dd=d;OpenLayers.INCHES_PER_UNIT.degrees=d;OpenLayers.DOTS_PER_INCH=
96;d=!0;b.Extension[0].Options&&b.Extension[0].Options[0].isBaseLayer&&b.Extension[0].Options[0].isBaseLayer[0]=="false"&&(d=!1);var c=!1;b.Extension[0].Options&&b.Extension[0].Options[0].useOverlay&&b.Extension[0].Options[0].useOverlay[0]=="true"&&(c=!0);var e=!0;b.SingleTile&&b.SingleTile[0]=="False"&&(e=!1);var j=!1;b.Extension[0].Options&&b.Extension[0].Options[0].useHttpTile&&b.Extension[0].Options[0].useHttpTile[0]=="true"&&(j=!0);var g="";b.Extension[0].Options&&b.Extension[0].Options[0].format&&
(g=b.Extension[0].Options[0].format[0]);b.Extension[0].ImageFormat&&(g=b.Extension[0].ImageFormat[0]);var h={isBaseLayer:d,useOverlay:c,useAsyncOverlay:!0,singleTile:e,useHttpTile:j,units:"m",maxExtent:new OpenLayers.Bounds.fromArray(a.extent)};j?(e={basemaplayergroupname:a.groups[0].groupName},g!=""&&(e.format=g),h.scales=a.FiniteDisplayScales,g=new OpenLayers.Layer.MapGuide(a.mapTitle,b.Extension[0].Options[0].tileCacheUrl[0].split(","),e,h)):(e?(map.projection="EPSG:"+a.epsg,e={mapname:a.mapName,
session:a.sessionId,behavior:2},g!=""&&(e.format=g),h.maxResolution="auto",h.maxScale=1,h.minScale=1E12,h.units="m"):(e={mapdefinition:a.mapId,session:a.sessionId,basemaplayergroupname:a.groups[0].groupName},g!=""&&(e.format=g),h.scales=a.FiniteDisplayScales),g=new OpenLayers.Layer.MapGuide(a.mapTitle,Rfs.tema.MapAgent,e,h));map.addLayer(g);$("#map").css("background-color",a.backgroundColor);startLocate&&d&&map.zoomToExtent(g.maxExtent);c?(map.removeLayer(redline,!1),map.removeLayer(vector,!1),map.removeLayer(crosshairsLayer,
!1),map.addLayer(redline),map.addLayer(vector),map.addLayer(crosshairsLayer)):addLayerToList({ol:g,name:g.name});if(!j)for(d=0;d<a.layers.length;d++)c=a.layers[d],c.displayInLegend&&addLayerToList({ol:g,name:c.legendLabel,id:c.uniqueId});$("#layerslist").listview("refresh")},error:function(a,b){alert(b)}})},error:function(b,a){alert(a)}})}
$("#Kort").live("pageshow",function(){fixContentHeight();if(Rfs.showInfo)Rfs.showInfo=!1,Rfs.useDrawControl?$("#KortInfoDraw").popup("open"):$("#KortInfo").popup("open");window.map||initMap()});
function fixContentHeight(){var b=$(window).height(),e=$("#headerKort"),d=$("#kortnavbar"),d=d.css("display")=="none"?b-e.outerHeight():b-d.outerHeight()-e.outerHeight();$("#map").css("height",d);$("#navigation").css("top",e.outerHeight()+10);window.map&&map.updateSize();$("#Photo").css("height",b);b=$("#photoButton");e=$(window).width();d=b.outerWidth();b.css("left",(e-d)/2)}
function addLayerToList(b){if(b.ol.isBaseLayer)map.projection=b.ol.projection.getCode();var e=$("<li>",{"data-icon":"check","class":b.ol.visibility?"checked":""}).append($("<a />",{text:b.name}).click(function(){$.mobile.changePage("#Kort");if(b.ol.CLASS_NAME=="OpenLayers.Layer.MapGuide"&&typeof b.id!=="undefined"){e.toggleClass("checked");if(e.hasClass("checked")){if(typeof b.ol.params.hideLayers!=="undefined")b.ol.params.hideLayers=b.ol.params.hideLayers.replace(b.id,"").replace(",,",",");b.ol.params.showLayers=
typeof b.ol.params.showLayers==="undefined"?b.id:b.ol.params.showLayers+","+b.id}else{if(typeof b.ol.params.showLayers!=="undefined")b.ol.params.showLayers=b.ol.params.showLayers.replace(b.id,"").replace(",,",",");b.ol.params.hideLayers=typeof b.ol.params.hideLayers==="undefined"?b.id:b.ol.params.hideLayers+","+b.id}b.ol.redraw()}else b.ol.isBaseLayer&&b.name==b.ol.name?(map.projection=b.ol.projection.getCode(),map.maxExtent=b.maxExtent,map.units=b.units,map.setBaseLayer(b.ol)):b.ol.setVisibility(!b.ol.getVisibility())})).appendTo("#layerslist");
b.ol.events.on({visibilitychanged:function(){$(e).toggleClass("checked")}})};
